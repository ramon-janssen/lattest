<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="annot"><span class="hs-comment">{- |
    This module contains building blocks for constructing out-of-the-box 'Adapter's.

    Note that adapters do not observe inputs by default. In other words, an input command
    from a test controller does not automatically lead to an input transition in the specification
    model. Use 'acceptingInputs' to observe all sent inputs, or 'acceptingInputsWithIncompletenessAsFailures'
    to also observe failures in processing inputs in the adapter. The latter is useful if the processing
    of inputs is defined partially, in which case some inputs cannot be sent to the adapter.
-}</span></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- TODO also expose a generic parsing transformation which takes a parser</span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Lattest.Adapter.StandardAdapters</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-13"></span><span class="annot"><span class="hs-comment">-- * Type Definition</span></span><span>
</span><span id="line-14"></span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier">Adapter</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- re-export so that a user of the library who wants to set up a testing experiment doesn't need to import the Adapter module at all</span><span>
</span><span id="line-15"></span><span class="annot"><span class="hs-comment">-- * Ready-to-use Adapters</span></span><span>
</span><span id="line-16"></span><span class="annot"><span class="hs-comment">-- ** Pure adapters</span></span><span>
</span><span id="line-17"></span><span class="annot"><span class="hs-comment">-- | Adapters which are defined in haskell itself.</span></span><span>
</span><span id="line-18"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#pureMealyAdapter"><span class="hs-identifier">pureMealyAdapter</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#pureAdapter"><span class="hs-identifier">pureAdapter</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span class="annot"><span class="hs-comment">-- ** Socket Adapters</span></span><span>
</span><span id="line-21"></span><span class="annot"><span class="hs-comment">-- *** Settings</span></span><span>
</span><span id="line-22"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier">SocketSettings</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#baseSocketSettings"><span class="hs-identifier">baseSocketSettings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span class="annot"><span class="hs-comment">-- *** Base Socket Adapters</span></span><span>
</span><span id="line-25"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapter"><span class="hs-identifier">connectSocketAdapter</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapterWith"><span class="hs-identifier">connectSocketAdapterWith</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span class="annot"><span class="hs-comment">-- *** Socket Adapters with JSON</span></span><span>
</span><span id="line-28"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapter"><span class="hs-identifier">connectJSONSocketAdapter</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterWith"><span class="hs-identifier">connectJSONSocketAdapterWith</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterAcceptingInputs"><span class="hs-identifier">connectJSONSocketAdapterAcceptingInputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterAcceptingInputsWith"><span class="hs-identifier">connectJSONSocketAdapterAcceptingInputsWith</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span class="annot"><span class="hs-comment">-- * Transformations on Adapters</span></span><span>
</span><span id="line-33"></span><span class="annot"><span class="hs-comment">-- ** Encoding and Decoding</span></span><span>
</span><span id="line-34"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#encodeUtf8"><span class="hs-identifier">encodeUtf8</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#decodeUtf8"><span class="hs-identifier">decodeUtf8</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#endecodeUtf8"><span class="hs-identifier">endecodeUtf8</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#encodeJSONTestChoices"><span class="hs-identifier">encodeJSONTestChoices</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#parseJSONActionsFromSut"><span class="hs-identifier">parseJSONActionsFromSut</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span class="annot"><span class="hs-comment">-- ** Observing Inputs</span></span><span>
</span><span id="line-40"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputs"><span class="hs-identifier">acceptingInputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputsWithIncompletenessAsFailures"><span class="hs-identifier">acceptingInputsWithIncompletenessAsFailures</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span class="annot"><span class="hs-comment">-- ** Timing and Quiescences</span></span><span>
</span><span id="line-43"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withQuiescence"><span class="hs-identifier">withQuiescence</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withQuiescenceMillis"><span class="hs-identifier">withQuiescenceMillis</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withInputDelay"><span class="hs-identifier">withInputDelay</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withInputDelayMillis"><span class="hs-identifier">withInputDelayMillis</span></a></span><span>
</span><span id="line-47"></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">where</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html"><span class="hs-identifier">Lattest.Adapter.Adapter</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier">Adapter</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#parseActionsFromSut"><span class="hs-identifier">parseActionsFromSut</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#mapTestChoices"><span class="hs-identifier">mapTestChoices</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#mapActionsFromSut"><span class="hs-identifier">mapActionsFromSut</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html"><span class="hs-identifier">Lattest.Adapter.Adapter</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Adap</span></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#map"><span class="hs-identifier">map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html"><span class="hs-identifier">Lattest.Model.Alphabet</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier">IOAct</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#Out"><span class="hs-identifier">Out</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOSuspAct"><span class="hs-identifier">IOSuspAct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#Suspended"><span class="hs-identifier">Suspended</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#Quiescence"><span class="hs-identifier">Quiescence</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#asSuspended"><span class="hs-identifier">asSuspended</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#fromSuspended"><span class="hs-identifier">fromSuspended</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html"><span class="hs-identifier">Lattest.Model.Alphabet</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier">IOAct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Lattest.Util.IOUtils.html"><span class="hs-identifier">Lattest.Util.IOUtils</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Util.IOUtils.html#ifM_"><span class="hs-identifier">ifM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Util.IOUtils.html#ifM"><span class="hs-identifier">ifM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Util.IOUtils.html#waitUntil"><span class="hs-identifier">waitUntil</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;|&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forever</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">void</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Extra</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(||^)</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TMVar</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newEmptyTMVarIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tryReadTMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeTMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isEmptyTMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">takeTMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TQueue</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">newTQueueIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTQueue</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeTQueue</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isEmptyTQueue</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Thread.Delay</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">delay</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FromJSON</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">ToJSON</span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UTCTime</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">getCurrentTime</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">addUTCTime</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">diffUTCTime</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">NominalDiffTime</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">secondsToNominalDiffTime</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">nominalDiffTimeToSeconds</span></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Conc</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forkIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newTVarIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">retry</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">atomically</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeTVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HostName</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PortNumber</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Socket</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">gracefulClose</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Utils</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">niceSocketsDo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">connectTCP</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeOutputStream</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Streams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">write</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams.Network</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">socketToStreams</span></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html"><span class="hs-identifier">System.IO.Streams.Synchronized</span></a></span><span class="hs-special">(</span><span class="annot"><a href="System.IO.Streams.Synchronized.html#fromInputStreamBuffered"><span class="hs-identifier">fromInputStreamBuffered</span></a></span><span class="hs-special">,</span><span class="annot"><a href="System.IO.Streams.Synchronized.html#makeTInputStream"><span class="hs-identifier">makeTInputStream</span></a></span><span class="hs-special">,</span><span class="annot"><a href="System.IO.Streams.Synchronized.html#hasInput"><span class="hs-identifier">hasInput</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html"><span class="hs-identifier">System.IO.Streams.Synchronized</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Streams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.IO.Streams.Synchronized.html#read"><span class="hs-identifier">read</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#unRead"><span class="hs-identifier">unRead</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromJSON</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">encode</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">Result</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Error</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Success</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">FromJSON</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">ToJSON</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.Parser</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">jsonNoDup</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Attoparsec.ByteString.Char8</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Parse</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bits.Utils</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">c2w8</span></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toStrict</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">snoc</span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding.Error</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lenientDecode</span></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Encoding</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">decodeUtf8With</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">encodeUtf8</span></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unpack</span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeInputStream</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Debug.Trace</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">trace</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- FIXME find a better alternative</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html"><span class="hs-identifier">Lattest.Model.Alphabet</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#TestChoice"><span class="hs-identifier">TestChoice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#choiceToActs"><span class="hs-identifier">choiceToActs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier">IOAct</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOSuspAct"><span class="hs-identifier">IOSuspAct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#Suspended"><span class="hs-identifier">Suspended</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#SuspendedIF"><span class="hs-identifier">SuspendedIF</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#isOutput"><span class="hs-identifier">isOutput</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#fromOutput"><span class="hs-identifier">fromOutput</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#IFAct"><span class="hs-identifier">IFAct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Model.Alphabet.html#InputAttempt"><span class="hs-identifier">InputAttempt</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">InputStream</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">OutputStream</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">makeInputStream</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">makeOutputStream</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">connect</span></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html"><span class="hs-identifier">System.IO.Streams.Synchronized</span></a></span><span class="hs-special">(</span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier">TInputStream</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#makeTInputStream"><span class="hs-identifier">makeTInputStream</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#fromInputStreamBuffered"><span class="hs-identifier">fromInputStreamBuffered</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#duplicate"><span class="hs-identifier">duplicate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#tryReadIO"><span class="hs-identifier">tryReadIO</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#tryReadIO%27"><span class="hs-identifier">tryReadIO'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#fromBuffer"><span class="hs-identifier">fromBuffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#mergeBufferedWith"><span class="hs-identifier">mergeBufferedWith</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#mapUnbuffered"><span class="hs-identifier">mapUnbuffered</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#fromTMVar"><span class="hs-identifier">fromTMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#readAll"><span class="hs-identifier">readAll</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#hasInput"><span class="hs-identifier">hasInput</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#Streamed"><span class="hs-identifier">Streamed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Streams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">write</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeTo</span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Conc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forkIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">orElse</span></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">filterWithKey</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">null</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">lookup</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toList</span></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">handle</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">PatternMatchFail</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SomeException</span></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RandomGen</span></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TMVar</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">newEmptyTMVarIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">putTMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Lattest.Util.Utils.html"><span class="hs-identifier">Lattest.Util.Utils</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Util.Utils.html#flipCoin"><span class="hs-identifier">flipCoin</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Util.Utils.html#takeRandom"><span class="hs-identifier">takeRandom</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Lattest.Util.IOUtils.html"><span class="hs-identifier">Lattest.Util.IOUtils</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Util.IOUtils.html#whileM"><span class="hs-identifier">whileM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Util.IOUtils.html#statefulIO"><span class="hs-identifier">statefulIO</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Util.IOUtils.html#statefulIO%27"><span class="hs-identifier">statefulIO'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Lattest.Util.IOUtils.html#doAfter"><span class="hs-identifier">doAfter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">singleton</span></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams.Combinators</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">contramap</span></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="annot"><span class="hs-comment">-- | Take an adapter that sends raw 'ByteString's, and transform it to an adapter that sends 'String's encoded in utf-8.</span></span><span>
</span><span id="line-101"></span><span id="local-6989586621679298734"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#encodeUtf8"><span class="hs-identifier hs-type">encodeUtf8</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298734"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298734"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-102"></span><span id="encodeUtf8"><span class="annot"><span class="annottext">encodeUtf8 :: forall act. Adapter act ByteString -&gt; IO (Adapter act String)
</span><a href="Lattest.Adapter.StandardAdapters.html#encodeUtf8"><span class="hs-identifier hs-var hs-var">encodeUtf8</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString)
-&gt; Adapter act ByteString -&gt; IO (Adapter act String)
forall i' i act. (i' -&gt; i) -&gt; Adapter act i -&gt; IO (Adapter act i')
</span><a href="Lattest.Adapter.Adapter.html#mapTestChoices"><span class="hs-identifier hs-var">mapTestChoices</span></a></span><span> </span><span class="annot"><span class="annottext">((String -&gt; ByteString)
 -&gt; Adapter act ByteString -&gt; IO (Adapter act String))
-&gt; (String -&gt; ByteString)
-&gt; Adapter act ByteString
-&gt; IO (Adapter act String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">Encoding.encodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; (String -&gt; Text) -&gt; String -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="annot"><span class="hs-comment">-- | Take an adapter that receives raw 'ByteString's, and transform it to an adapter that receives 'String's decoded from utf-8.</span></span><span>
</span><span id="line-105"></span><span id="local-6989586621679298749"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#decodeUtf8"><span class="hs-identifier hs-type">decodeUtf8</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><a href="#local-6989586621679298749"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="#local-6989586621679298749"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-106"></span><span id="decodeUtf8"><span class="annot"><span class="annottext">decodeUtf8 :: forall i. Adapter ByteString i -&gt; IO (Adapter String i)
</span><a href="Lattest.Adapter.StandardAdapters.html#decodeUtf8"><span class="hs-identifier hs-var hs-var">decodeUtf8</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; String)
-&gt; Adapter ByteString i -&gt; IO (Adapter String i)
forall act act' i.
(act -&gt; act') -&gt; Adapter act i -&gt; IO (Adapter act' i)
</span><a href="Lattest.Adapter.Adapter.html#mapActionsFromSut"><span class="hs-identifier hs-var">mapActionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">((ByteString -&gt; String)
 -&gt; Adapter ByteString i -&gt; IO (Adapter String i))
-&gt; (ByteString -&gt; String)
-&gt; Adapter ByteString i
-&gt; IO (Adapter String i)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">Text.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; (ByteString -&gt; Text) -&gt; ByteString -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OnDecodeError -&gt; ByteString -&gt; Text
</span><span class="hs-identifier hs-var">Encoding.decodeUtf8With</span></span><span> </span><span class="annot"><span class="annottext">OnDecodeError
</span><span class="hs-identifier hs-var">lenientDecode</span></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="annot"><span class="hs-comment">-- | Take an adapter that sends and receives raw 'ByteString's, and transform it to an adapter that sends and receives 'String's, encoded in utf-8 and decoded from utf-8.</span></span><span>
</span><span id="line-109"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#endecodeUtf8"><span class="hs-identifier hs-type">endecodeUtf8</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span id="endecodeUtf8"><span class="annot"><span class="annottext">endecodeUtf8 :: Adapter ByteString ByteString -&gt; IO (Adapter String String)
</span><a href="Lattest.Adapter.StandardAdapters.html#endecodeUtf8"><span class="hs-identifier hs-var hs-var">endecodeUtf8</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString)
-&gt; (ByteString -&gt; String)
-&gt; Adapter ByteString ByteString
-&gt; IO (Adapter String String)
forall i' i act act'.
(i' -&gt; i) -&gt; (act -&gt; act') -&gt; Adapter act i -&gt; IO (Adapter act' i')
</span><a href="Lattest.Adapter.Adapter.html#map"><span class="hs-identifier hs-var">Adap.map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">Encoding.encodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; (String -&gt; Text) -&gt; String -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">Text.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; (ByteString -&gt; Text) -&gt; ByteString -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OnDecodeError -&gt; ByteString -&gt; Text
</span><span class="hs-identifier hs-var">Encoding.decodeUtf8With</span></span><span> </span><span class="annot"><span class="annottext">OnDecodeError
</span><span class="hs-identifier hs-var">lenientDecode</span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span id="local-6989586621679298759"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#encodeJSON"><span class="hs-identifier hs-type">encodeJSON</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679298759"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298759"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span></span><span>
</span><span id="line-113"></span><span id="encodeJSON"><span class="annot"><span class="annottext">encodeJSON :: forall i. ToJSON i =&gt; i -&gt; ByteString
</span><a href="Lattest.Adapter.StandardAdapters.html#encodeJSON"><span class="hs-identifier hs-var hs-var">encodeJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LazyByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">toStrict</span></span><span> </span><span class="annot"><span class="annottext">(LazyByteString -&gt; ByteString)
-&gt; (i -&gt; LazyByteString) -&gt; i -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LazyByteString -&gt; Word8 -&gt; LazyByteString)
-&gt; Word8 -&gt; LazyByteString -&gt; LazyByteString
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">LazyByteString -&gt; Word8 -&gt; LazyByteString
</span><span class="hs-identifier hs-var">snoc</span></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; LazyByteString -&gt; LazyByteString)
-&gt; Word8 -&gt; LazyByteString -&gt; LazyByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Word8
</span><span class="hs-identifier hs-var">c2w8</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\n'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LazyByteString -&gt; LazyByteString)
-&gt; (i -&gt; LazyByteString) -&gt; i -&gt; LazyByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">i -&gt; LazyByteString
forall a. ToJSON a =&gt; a -&gt; LazyByteString
</span><span class="hs-identifier hs-var">encode</span></span><span> </span><span class="hs-comment">-- encode as strict ByteString and append a newline as separator</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="annot"><span class="hs-comment">-- | Take an adapter that sends raw 'ByteString's, and transform it to an adapter that sends any type encoded in JSON.</span></span><span>
</span><span id="line-116"></span><span id="local-6989586621679298767"><span id="local-6989586621679298768"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#encodeJSONTestChoices"><span class="hs-identifier hs-type">encodeJSONTestChoices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679298767"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298768"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298768"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298767"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-117"></span><span id="encodeJSONTestChoices"><span class="annot"><span class="annottext">encodeJSONTestChoices :: forall i act.
ToJSON i =&gt;
Adapter act ByteString -&gt; IO (Adapter act i)
</span><a href="Lattest.Adapter.StandardAdapters.html#encodeJSONTestChoices"><span class="hs-identifier hs-var hs-var">encodeJSONTestChoices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(i -&gt; ByteString) -&gt; Adapter act ByteString -&gt; IO (Adapter act i)
forall i' i act. (i' -&gt; i) -&gt; Adapter act i -&gt; IO (Adapter act i')
</span><a href="Lattest.Adapter.Adapter.html#mapTestChoices"><span class="hs-identifier hs-var">mapTestChoices</span></a></span><span> </span><span class="annot"><span class="annottext">i -&gt; ByteString
forall i. ToJSON i =&gt; i -&gt; ByteString
</span><a href="Lattest.Adapter.StandardAdapters.html#encodeJSON"><span class="hs-identifier hs-var">encodeJSON</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="annot"><span class="hs-comment">-- | Take an adapter that receives raw 'ByteString's, and transform it to an adapter that receives any type decoded from JSON.</span></span><span>
</span><span id="line-120"></span><span id="local-6989586621679298771"><span id="local-6989586621679298773"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#parseJSONActionsFromSut"><span class="hs-identifier hs-type">parseJSONActionsFromSut</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679298771"><span class="hs-identifier hs-type">act</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><a href="#local-6989586621679298773"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298771"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298773"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-121"></span><span id="parseJSONActionsFromSut"><span class="annot"><span class="annottext">parseJSONActionsFromSut :: forall act i.
FromJSON act =&gt;
Adapter ByteString i -&gt; IO (Adapter act i)
</span><a href="Lattest.Adapter.StandardAdapters.html#parseJSONActionsFromSut"><span class="hs-identifier hs-var hs-var">parseJSONActionsFromSut</span></a></span></span><span> </span><span id="local-6989586621679299204"><span class="annot"><span class="annottext">Adapter ByteString i
</span><a href="#local-6989586621679299204"><span class="hs-identifier hs-var">adap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621679299205"><span class="annot"><span class="annottext">Adapter Value i
</span><a href="#local-6989586621679299205"><span class="hs-identifier hs-var">valueAdap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Parser Value -&gt; Adapter ByteString i -&gt; IO (Adapter Value i)
forall act i.
Parser act -&gt; Adapter ByteString i -&gt; IO (Adapter act i)
</span><a href="Lattest.Adapter.Adapter.html#parseActionsFromSut"><span class="hs-identifier hs-var">parseActionsFromSut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser ()
</span><span class="hs-identifier hs-var">Parse.skipSpace</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Value -&gt; Parser Value
forall a b.
Parser ByteString a -&gt; Parser ByteString b -&gt; Parser ByteString b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser Value
</span><span class="hs-identifier hs-var">jsonNoDup</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Adapter ByteString i
</span><a href="#local-6989586621679299204"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">(Value -&gt; act) -&gt; Adapter Value i -&gt; IO (Adapter act i)
forall act act' i.
(act -&gt; act') -&gt; Adapter act i -&gt; IO (Adapter act' i)
</span><a href="Lattest.Adapter.Adapter.html#mapActionsFromSut"><span class="hs-identifier hs-var">mapActionsFromSut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result act -&gt; act
forall {a}. Result a -&gt; a
</span><a href="#local-6989586621679299207"><span class="hs-identifier hs-var">fromResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Result act -&gt; act) -&gt; (Value -&gt; Result act) -&gt; Value -&gt; act
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Result act
forall a. FromJSON a =&gt; Value -&gt; Result a
</span><span class="hs-identifier hs-var">fromJSON</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Adapter Value i
</span><a href="#local-6989586621679299205"><span class="hs-identifier hs-var">valueAdap</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679299207"><span class="annot"><span class="annottext">fromResult :: Result a -&gt; a
</span><a href="#local-6989586621679299207"><span class="hs-identifier hs-var hs-var">fromResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Success</span></span><span> </span><span id="local-6989586621679299210"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299210"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299210"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><a href="#local-6989586621679299207"><span class="hs-identifier hs-var">fromResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span id="local-6989586621679299211"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299211"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; a -&gt; a
forall a. String -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">Debug.Trace.trace</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299211"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; a -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679299211"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-comment">-- TODO handle error case</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- transform an adapter to transfer input commands to observed actions</span><span>
</span><span id="line-129"></span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- architecture:</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- input--combinedInputOS---fduplicate---adapInputOS---\</span><span>
</span><span id="line-132"></span><span class="hs-comment">--                                \                     \</span><span>
</span><span id="line-133"></span><span class="hs-comment">--                                |                      \</span><span>
</span><span id="line-134"></span><span class="hs-comment">--                       loopbackInputOS                 |</span><span>
</span><span id="line-135"></span><span class="hs-comment">--                                v                      v</span><span>
</span><span id="line-136"></span><span class="hs-comment">--                       loopbackActionOS             +------+</span><span>
</span><span id="line-137"></span><span class="hs-comment">--                       [loopbackBuffer]             | adap |</span><span>
</span><span id="line-138"></span><span class="hs-comment">--                       loopbackActionIS             +------+</span><span>
</span><span id="line-139"></span><span class="hs-comment">--                                |                      |</span><span>
</span><span id="line-140"></span><span class="hs-comment">--                                v                      |</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- &lt;--output--combinedActionIS--fmerge &lt;--adapActionIS---/</span><span>
</span><span id="line-142"></span><span id="local-6989586621679298792"><span id="local-6989586621679298793"><span id="local-6989586621679298794"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#loopbackAdapter"><span class="hs-identifier hs-type">loopbackAdapter</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298792"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298793"><span class="hs-identifier hs-type">ic</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="#local-6989586621679298794"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="#local-6989586621679298793"><span class="hs-identifier hs-type">ic</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="#local-6989586621679298793"><span class="hs-identifier hs-type">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier hs-type">TInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298794"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298792"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier hs-type">TInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298794"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298792"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier hs-type">TInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298794"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298792"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298794"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298792"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679298793"><span class="hs-identifier hs-type">ic</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-147"></span><span id="loopbackAdapter"><span class="annot"><span class="annottext">loopbackAdapter :: forall o ic i.
Adapter o ic
-&gt; (OutputStream i -&gt; OutputStream ic -&gt; IO (OutputStream ic))
-&gt; (TInputStream (IOAct i o)
    -&gt; TInputStream (IOAct i o) -&gt; IO (TInputStream (IOAct i o)))
-&gt; IO (Adapter (IOAct i o) ic)
</span><a href="Lattest.Adapter.StandardAdapters.html#loopbackAdapter"><span class="hs-identifier hs-var hs-var">loopbackAdapter</span></a></span></span><span> </span><span id="local-6989586621679299223"><span class="annot"><span class="annottext">Adapter o ic
</span><a href="#local-6989586621679299223"><span class="hs-identifier hs-var">adap</span></a></span></span><span> </span><span id="local-6989586621679299224"><span class="annot"><span class="annottext">OutputStream i -&gt; OutputStream ic -&gt; IO (OutputStream ic)
</span><a href="#local-6989586621679299224"><span class="hs-identifier hs-var">fduplicate</span></a></span></span><span> </span><span id="local-6989586621679299225"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o) -&gt; IO (TInputStream (IOAct i o))
</span><a href="#local-6989586621679299225"><span class="hs-identifier hs-var">fmerge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>    </span><span id="local-6989586621679299226"><span class="annot"><span class="annottext">TMVar (Maybe (IOAct i o))
</span><a href="#local-6989586621679299226"><span class="hs-identifier hs-var">loopbackBuffer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar (Maybe (IOAct i o)))
forall a. IO (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-149"></span><span>    </span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621679299227"><span class="annot"><span class="annottext">OutputStream (IOAct i o)
</span><a href="#local-6989586621679299227"><span class="hs-identifier hs-var">loopbackActionOS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Maybe (IOAct i o) -&gt; IO ()) -&gt; IO (OutputStream (IOAct i o))
forall a. (Maybe a -&gt; IO ()) -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">makeOutputStream</span></span><span> </span><span class="annot"><span class="annottext">((Maybe (IOAct i o) -&gt; IO ()) -&gt; IO (OutputStream (IOAct i o)))
-&gt; (Maybe (IOAct i o) -&gt; IO ()) -&gt; IO (OutputStream (IOAct i o))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ())
-&gt; (Maybe (IOAct i o) -&gt; STM ()) -&gt; Maybe (IOAct i o) -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe (IOAct i o)) -&gt; Maybe (IOAct i o) -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe (IOAct i o))
</span><a href="#local-6989586621679299226"><span class="hs-identifier hs-var">loopbackBuffer</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621679299228"><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299228"><span class="hs-identifier hs-var">loopbackInputOS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputStream (IOAct i o) -&gt; IO (OutputStream i)
forall {a} {a}.
TestChoice a a =&gt;
OutputStream a -&gt; IO (OutputStream a)
</span><a href="Lattest.Adapter.StandardAdapters.html#actionToInputOS"><span class="hs-identifier hs-var">actionToInputOS</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream (IOAct i o)
</span><a href="#local-6989586621679299227"><span class="hs-identifier hs-var">loopbackActionOS</span></a></span><span> </span><span class="hs-comment">-- map type i to type IOAct i o</span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299230"><span class="annot"><span class="annottext">adapInputOS :: OutputStream ic
</span><a href="#local-6989586621679299230"><span class="hs-identifier hs-var hs-var">adapInputOS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Adapter o ic -&gt; OutputStream ic
forall act i. Adapter act i -&gt; OutputStream i
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter o ic
</span><a href="#local-6989586621679299223"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span id="local-6989586621679299232"><span class="annot"><span class="annottext">OutputStream ic
</span><a href="#local-6989586621679299232"><span class="hs-identifier hs-var">combinedInputOS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputStream i -&gt; OutputStream ic -&gt; IO (OutputStream ic)
</span><a href="#local-6989586621679299224"><span class="hs-identifier hs-var">fduplicate</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299228"><span class="hs-identifier hs-var">loopbackInputOS</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream ic
</span><a href="#local-6989586621679299230"><span class="hs-identifier hs-var">adapInputOS</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span>
</span><span id="line-155"></span><span>    </span><span id="local-6989586621679299233"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299233"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe (IOAct i o)) -&gt; IO (TInputStream (IOAct i o))
forall a. TMVar (Maybe a) -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#fromTMVar"><span class="hs-identifier hs-var">fromTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar (Maybe (IOAct i o))
</span><a href="#local-6989586621679299226"><span class="hs-identifier hs-var">loopbackBuffer</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299234"><span class="annot"><span class="annottext">adapActionIS :: TInputStream (IOAct i o)
</span><a href="#local-6989586621679299234"><span class="hs-identifier hs-var hs-var">adapActionIS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Adapter o ic -&gt; TInputStream (IOAct i o)
forall {a} {i} {i}. Adapter a i -&gt; TInputStream (IOAct i a)
</span><a href="Lattest.Adapter.StandardAdapters.html#outputToActionIS"><span class="hs-identifier hs-var">outputToActionIS</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter o ic
</span><a href="#local-6989586621679299223"><span class="hs-identifier hs-var">adap</span></a></span><span> </span><span class="hs-comment">-- map type o to IOAct i o</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- loopback first: in case of a quick response to an input, the merging thread may see the input and output at the same time.</span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621679299236"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299236"><span class="hs-identifier hs-var">combinedActionIS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o) -&gt; IO (TInputStream (IOAct i o))
</span><a href="#local-6989586621679299225"><span class="hs-identifier hs-var">fmerge</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299233"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
forall {i}. TInputStream (IOAct i o)
</span><a href="#local-6989586621679299234"><span class="hs-identifier hs-var">adapActionIS</span></a></span><span> </span><span class="hs-comment">-- the merge buffer lives in here implicitly</span><span>
</span><span id="line-159"></span><span>     </span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><span class="annottext">Adapter (IOAct i o) ic -&gt; IO (Adapter (IOAct i o) ic)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Adapter (IOAct i o) ic -&gt; IO (Adapter (IOAct i o) ic))
-&gt; Adapter (IOAct i o) ic -&gt; IO (Adapter (IOAct i o) ic)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="annottext">inputCommandsToSut :: OutputStream ic
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputStream ic
</span><a href="#local-6989586621679299232"><span class="hs-identifier hs-var">combinedInputOS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><span class="annottext">actionsFromSut :: TInputStream (IOAct i o)
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299236"><span class="hs-identifier hs-var">combinedActionIS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>        </span><span class="annot"><span class="annottext">close :: IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Adapter o ic -&gt; IO ()
forall act i. Adapter act i -&gt; IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter o ic
</span><a href="#local-6989586621679299223"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span id="outputToActionIS"><span class="annot"><span class="annottext">outputToActionIS :: Adapter a i -&gt; TInputStream (IOAct i a)
</span><a href="Lattest.Adapter.StandardAdapters.html#outputToActionIS"><span class="hs-identifier hs-var hs-var">outputToActionIS</span></a></span></span><span> </span><span id="local-6989586621679299241"><span class="annot"><span class="annottext">Adapter a i
</span><a href="#local-6989586621679299241"><span class="hs-identifier hs-var">adap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; IOAct i a)
-&gt; (IOAct i a -&gt; a) -&gt; TInputStream a -&gt; TInputStream (IOAct i a)
forall a b.
(a -&gt; b) -&gt; (b -&gt; a) -&gt; TInputStream a -&gt; TInputStream b
</span><a href="System.IO.Streams.Synchronized.html#mapUnbuffered"><span class="hs-identifier hs-var">mapUnbuffered</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; IOAct i a
forall i o. o -&gt; IOAct i o
</span><a href="Lattest.Model.Alphabet.html#Out"><span class="hs-identifier hs-var">Out</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; IOAct i a -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;acceptingInputs buffer from SUT does not support pushback&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Adapter a i -&gt; TInputStream a
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter a i
</span><a href="#local-6989586621679299241"><span class="hs-identifier hs-var">adap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span id="actionToInputOS"><span class="annot"><span class="annottext">actionToInputOS :: OutputStream a -&gt; IO (OutputStream a)
</span><a href="Lattest.Adapter.StandardAdapters.html#actionToInputOS"><span class="hs-identifier hs-var hs-var">actionToInputOS</span></a></span></span><span> </span><span id="local-6989586621679299249"><span class="annot"><span class="annottext">OutputStream a
</span><a href="#local-6989586621679299249"><span class="hs-identifier hs-var">actionOS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputStream a -&gt; IO (OutputStream [a])
forall a. OutputStream a -&gt; IO (OutputStream [a])
</span><a href="Lattest.Adapter.StandardAdapters.html#streamSequence"><span class="hs-identifier hs-var">streamSequence</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream a
</span><a href="#local-6989586621679299249"><span class="hs-identifier hs-var">actionOS</span></a></span><span> </span><span class="annot"><span class="annottext">IO (OutputStream [a])
-&gt; (OutputStream [a] -&gt; IO (OutputStream a)) -&gt; IO (OutputStream a)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; [a]) -&gt; OutputStream [a] -&gt; IO (OutputStream a)
forall a b. (a -&gt; b) -&gt; OutputStream b -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">contramap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a]
forall i act. TestChoice i act =&gt; i -&gt; [act]
</span><a href="Lattest.Model.Alphabet.html#choiceToActs"><span class="hs-identifier hs-var">choiceToActs</span></a></span><span>
</span><span id="line-168"></span><span class="hs-comment">-- direct pushbacks to the streams below is not needed, the merge buffer will handle pushbacks instead</span><span>
</span><span id="line-169"></span><span id="local-6989586621679298834"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#streamSequence"><span class="hs-identifier hs-type">streamSequence</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="#local-6989586621679298834"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679298834"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-170"></span><span id="streamSequence"><span class="annot"><span class="annottext">streamSequence :: forall a. OutputStream a -&gt; IO (OutputStream [a])
</span><a href="Lattest.Adapter.StandardAdapters.html#streamSequence"><span class="hs-identifier hs-var hs-var">streamSequence</span></a></span></span><span> </span><span id="local-6989586621679299251"><span class="annot"><span class="annottext">OutputStream a
</span><a href="#local-6989586621679299251"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe [a] -&gt; IO ()) -&gt; IO (OutputStream [a])
forall a. (Maybe a -&gt; IO ()) -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">makeOutputStream</span></span><span> </span><span class="annot"><span class="annottext">((Maybe [a] -&gt; IO ()) -&gt; IO (OutputStream [a]))
-&gt; (Maybe [a] -&gt; IO ()) -&gt; IO (OutputStream [a])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; IO ()) -&gt; Maybe [a] -&gt; IO ()
forall a. (Maybe a -&gt; IO ()) -&gt; Maybe [a] -&gt; IO ()
</span><a href="Lattest.Adapter.StandardAdapters.html#doMaybeSequenceCmd"><span class="hs-identifier hs-var">doMaybeSequenceCmd</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe a -&gt; IO ()) -&gt; Maybe [a] -&gt; IO ())
-&gt; (Maybe a -&gt; IO ()) -&gt; Maybe [a] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OutputStream a -&gt; Maybe a -&gt; IO ()
forall a. OutputStream a -&gt; Maybe a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.writeTo</span></span><span> </span><span class="annot"><span class="annottext">OutputStream a
</span><a href="#local-6989586621679299251"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-171"></span><span id="local-6989586621679298840"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#doMaybeSequenceCmd"><span class="hs-identifier hs-type">doMaybeSequenceCmd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679298840"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679298840"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-172"></span><span id="doMaybeSequenceCmd"><span class="annot"><span class="annottext">doMaybeSequenceCmd :: forall a. (Maybe a -&gt; IO ()) -&gt; Maybe [a] -&gt; IO ()
</span><a href="Lattest.Adapter.StandardAdapters.html#doMaybeSequenceCmd"><span class="hs-identifier hs-var hs-var">doMaybeSequenceCmd</span></a></span></span><span> </span><span id="local-6989586621679299258"><span class="annot"><span class="annottext">Maybe a -&gt; IO ()
</span><a href="#local-6989586621679299258"><span class="hs-identifier hs-var">writeMaybeAct</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe [a]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; IO ()
</span><a href="#local-6989586621679299258"><span class="hs-identifier hs-var">writeMaybeAct</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-173"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#doMaybeSequenceCmd"><span class="hs-identifier hs-var">doMaybeSequenceCmd</span></a></span><span> </span><span id="local-6989586621679299259"><span class="annot"><span class="annottext">Maybe a -&gt; IO ()
</span><a href="#local-6989586621679299259"><span class="hs-identifier hs-var">writeMaybeAct</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299260"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679299260"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[IO ()] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">([IO ()] -&gt; IO ()) -&gt; [IO ()] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; IO ()
</span><a href="#local-6989586621679299259"><span class="hs-identifier hs-var">writeMaybeAct</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; IO ()) -&gt; (a -&gt; Maybe a) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; IO ()) -&gt; [a] -&gt; [IO ()]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679299260"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="annot"><span class="hs-comment">{- |
    Transform a given Adapter to accept all inputs. In other words, every selected input command directly becomes an observed input action.
    Every observed output from the given Adapter becomes an output action.
-}</span></span><span>
</span><span id="line-179"></span><span id="local-6989586621679298850"><span id="local-6989586621679298851"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputs"><span class="hs-identifier hs-type">acceptingInputs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298850"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298851"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298851"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298850"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679298851"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-180"></span><span id="acceptingInputs"><span class="annot"><span class="annottext">acceptingInputs :: forall o i. Adapter o i -&gt; IO (Adapter (IOAct i o) i)
</span><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputs"><span class="hs-identifier hs-var hs-var">acceptingInputs</span></a></span></span><span> </span><span id="local-6989586621679299263"><span class="annot"><span class="annottext">Adapter o i
</span><a href="#local-6989586621679299263"><span class="hs-identifier hs-var">adap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Adapter o i
-&gt; (OutputStream i -&gt; OutputStream i -&gt; IO (OutputStream i))
-&gt; (TInputStream (IOAct i o)
    -&gt; TInputStream (IOAct i o) -&gt; IO (TInputStream (IOAct i o)))
-&gt; IO (Adapter (IOAct i o) i)
forall o ic i.
Adapter o ic
-&gt; (OutputStream i -&gt; OutputStream ic -&gt; IO (OutputStream ic))
-&gt; (TInputStream (IOAct i o)
    -&gt; TInputStream (IOAct i o) -&gt; IO (TInputStream (IOAct i o)))
-&gt; IO (Adapter (IOAct i o) ic)
</span><a href="Lattest.Adapter.StandardAdapters.html#loopbackAdapter"><span class="hs-identifier hs-var">loopbackAdapter</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter o i
</span><a href="#local-6989586621679299263"><span class="hs-identifier hs-var">adap</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream i -&gt; OutputStream i -&gt; IO (OutputStream i)
forall a. OutputStream a -&gt; OutputStream a -&gt; IO (OutputStream a)
</span><a href="System.IO.Streams.Synchronized.html#duplicate"><span class="hs-identifier hs-var">duplicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TInputStream (IOAct i o)
 -&gt; TInputStream (IOAct i o) -&gt; STM [Maybe (IOAct i o)])
-&gt; TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o)
-&gt; IO (TInputStream (IOAct i o))
forall a.
(TInputStream a -&gt; TInputStream a -&gt; STM [Maybe a])
-&gt; TInputStream a -&gt; TInputStream a -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#mergeBufferedWith"><span class="hs-identifier hs-var">mergeBufferedWith</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o) -&gt; STM [Maybe (IOAct i o)]
forall i o.
TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o) -&gt; STM [Maybe (IOAct i o)]
</span><a href="Lattest.Adapter.StandardAdapters.html#mergeActions"><span class="hs-identifier hs-var">mergeActions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- merging is done by reading an input, followed by all outputs that are then available. If no input is available, then read an output instead</span><span>
</span><span id="line-182"></span><span id="local-6989586621679298856"><span id="local-6989586621679298857"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#mergeActions"><span class="hs-identifier hs-type">mergeActions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier hs-type">TInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298856"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298857"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier hs-type">TInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298856"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298857"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298856"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298857"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-183"></span><span id="mergeActions"><span class="annot"><span class="annottext">mergeActions :: forall i o.
TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o) -&gt; STM [Maybe (IOAct i o)]
</span><a href="Lattest.Adapter.StandardAdapters.html#mergeActions"><span class="hs-identifier hs-var hs-var">mergeActions</span></a></span></span><span> </span><span id="local-6989586621679299273"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299273"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span></span><span> </span><span id="local-6989586621679299274"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299274"><span class="hs-identifier hs-var">adapActionIS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621679299275"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299275"><span class="hs-identifier hs-var">hasLoopbackAction</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM Bool
forall a. TInputStream a -&gt; STM Bool
</span><a href="System.IO.Streams.Synchronized.html#hasInput"><span class="hs-identifier hs-var">hasInput</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299273"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299275"><span class="hs-identifier hs-var">hasLoopbackAction</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>            </span><span id="local-6989586621679299276"><span class="annot"><span class="annottext">Maybe (IOAct i o)
</span><a href="#local-6989586621679299276"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a. TInputStream a -&gt; STM (Maybe a)
</span><a href="System.IO.Streams.Synchronized.html#read"><span class="hs-identifier hs-var">Streams.read</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299273"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span><span>
</span><span id="line-188"></span><span>            </span><span id="local-6989586621679299277"><span class="annot"><span class="annottext">[Maybe (IOAct i o)]
</span><a href="#local-6989586621679299277"><span class="hs-identifier hs-var">outs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM [Maybe (IOAct i o)]
forall a. TInputStream a -&gt; STM [Maybe a]
</span><a href="System.IO.Streams.Synchronized.html#readAll"><span class="hs-identifier hs-var">readAll</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299274"><span class="hs-identifier hs-var">adapActionIS</span></a></span><span>
</span><span id="line-189"></span><span>            </span><span class="annot"><span class="annottext">[Maybe (IOAct i o)] -&gt; STM [Maybe (IOAct i o)]
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (IOAct i o)
</span><a href="#local-6989586621679299276"><span class="hs-identifier hs-var">inp</span></a></span><span class="annot"><span class="annottext">Maybe (IOAct i o) -&gt; [Maybe (IOAct i o)] -&gt; [Maybe (IOAct i o)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Maybe (IOAct i o)]
</span><a href="#local-6989586621679299277"><span class="hs-identifier hs-var">outs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-191"></span><span>            </span><span id="local-6989586621679299278"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299278"><span class="hs-identifier hs-var">hasAdapAction</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM Bool
forall a. TInputStream a -&gt; STM Bool
</span><a href="System.IO.Streams.Synchronized.html#hasInput"><span class="hs-identifier hs-var">hasInput</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299274"><span class="hs-identifier hs-var">adapActionIS</span></a></span><span>
</span><span id="line-192"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299278"><span class="hs-identifier hs-var">hasAdapAction</span></a></span><span>
</span><span id="line-193"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (IOAct i o) -&gt; [Maybe (IOAct i o)]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">singleton</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IOAct i o) -&gt; [Maybe (IOAct i o)])
-&gt; STM (Maybe (IOAct i o)) -&gt; STM [Maybe (IOAct i o)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a. TInputStream a -&gt; STM (Maybe a)
</span><a href="System.IO.Streams.Synchronized.html#read"><span class="hs-identifier hs-var">Streams.read</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299274"><span class="hs-identifier hs-var">adapActionIS</span></a></span><span>
</span><span id="line-194"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">STM [Maybe (IOAct i o)]
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="annot"><span class="hs-comment">{- |
    Transform a given Adapter to accept all inputs, but if the given Adapter would call an undefined case in a partial function, then interpret this
    as an observed input failure. Any input command that does not call undefined cases of partial functions directly become observed input action.
    Every observed output from the given Adapter becomes an output action.

    Input failures are useful for Adapters written in pure haskell. Instead of only writing complete functions to process input commands, where unexpected
    input commands may e.g. lead to an error output, the adapter may also just process input commands with partial functions instead, avoiding some boilerplate code.
-}</span></span><span>
</span><span id="line-204"></span><span id="local-6989586621679298865"><span id="local-6989586621679298866"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputsWithIncompletenessAsFailures"><span class="hs-identifier hs-type">acceptingInputsWithIncompletenessAsFailures</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298865"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298866"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IFAct"><span class="hs-identifier hs-type">IFAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298866"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298865"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679298866"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-205"></span><span id="acceptingInputsWithIncompletenessAsFailures"><span class="annot"><span class="annottext">acceptingInputsWithIncompletenessAsFailures :: forall o i. Adapter o i -&gt; IO (Adapter (IFAct i o) i)
</span><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputsWithIncompletenessAsFailures"><span class="hs-identifier hs-var hs-var">acceptingInputsWithIncompletenessAsFailures</span></a></span></span><span> </span><span id="local-6989586621679299280"><span class="annot"><span class="annottext">Adapter o i
</span><a href="#local-6989586621679299280"><span class="hs-identifier hs-var">adap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621679299281"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299281"><span class="hs-identifier hs-var">blockAdapActionsTVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (TVar Bool)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- during duplication, block observation of actions from the adapter</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">Adapter o i
-&gt; (OutputStream (InputAttempt i)
    -&gt; OutputStream i -&gt; IO (OutputStream i))
-&gt; (TInputStream (IFAct i o)
    -&gt; TInputStream (IFAct i o) -&gt; IO (TInputStream (IFAct i o)))
-&gt; IO (Adapter (IFAct i o) i)
forall o ic i.
Adapter o ic
-&gt; (OutputStream i -&gt; OutputStream ic -&gt; IO (OutputStream ic))
-&gt; (TInputStream (IOAct i o)
    -&gt; TInputStream (IOAct i o) -&gt; IO (TInputStream (IOAct i o)))
-&gt; IO (Adapter (IOAct i o) ic)
</span><a href="Lattest.Adapter.StandardAdapters.html#loopbackAdapter"><span class="hs-identifier hs-var">loopbackAdapter</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter o i
</span><a href="#local-6989586621679299280"><span class="hs-identifier hs-var">adap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar Bool
-&gt; OutputStream (InputAttempt i)
-&gt; OutputStream i
-&gt; IO (OutputStream i)
forall i.
TVar Bool
-&gt; OutputStream (InputAttempt i)
-&gt; OutputStream i
-&gt; IO (OutputStream i)
</span><a href="#local-6989586621679299282"><span class="hs-identifier hs-var">duplicateHandlingIncompleteness</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299281"><span class="hs-identifier hs-var">blockAdapActionsTVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TInputStream (IFAct i o)
 -&gt; TInputStream (IFAct i o) -&gt; STM [Maybe (IFAct i o)])
-&gt; TInputStream (IFAct i o)
-&gt; TInputStream (IFAct i o)
-&gt; IO (TInputStream (IFAct i o))
forall a.
(TInputStream a -&gt; TInputStream a -&gt; STM [Maybe a])
-&gt; TInputStream a -&gt; TInputStream a -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#mergeBufferedWith"><span class="hs-identifier hs-var">mergeBufferedWith</span></a></span><span> </span><span class="annot"><span class="annottext">((TInputStream (IFAct i o)
  -&gt; TInputStream (IFAct i o) -&gt; STM [Maybe (IFAct i o)])
 -&gt; TInputStream (IFAct i o)
 -&gt; TInputStream (IFAct i o)
 -&gt; IO (TInputStream (IFAct i o)))
-&gt; (TInputStream (IFAct i o)
    -&gt; TInputStream (IFAct i o) -&gt; STM [Maybe (IFAct i o)])
-&gt; TInputStream (IFAct i o)
-&gt; TInputStream (IFAct i o)
-&gt; IO (TInputStream (IFAct i o))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
-&gt; TInputStream (IFAct i o)
-&gt; TInputStream (IFAct i o)
-&gt; STM [Maybe (IFAct i o)]
forall i o.
TVar Bool
-&gt; TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o)
-&gt; STM [Maybe (IOAct i o)]
</span><a href="#local-6989586621679299283"><span class="hs-identifier hs-var">mergeActionsPaused</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299281"><span class="hs-identifier hs-var">blockAdapActionsTVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621679298874"><span id="local-6989586621679298875"><span class="annot"><a href="#local-6989586621679299283"><span class="hs-identifier hs-type">mergeActionsPaused</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier hs-type">TInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298874"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298875"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.IO.Streams.Synchronized.html#TInputStream"><span class="hs-identifier hs-type">TInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298874"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298875"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298874"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298875"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679299283"><span class="annot"><span class="annottext">mergeActionsPaused :: forall i o.
TVar Bool
-&gt; TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o)
-&gt; STM [Maybe (IOAct i o)]
</span><a href="#local-6989586621679299283"><span class="hs-identifier hs-var hs-var">mergeActionsPaused</span></a></span></span><span> </span><span id="local-6989586621679299286"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299286"><span class="hs-identifier hs-var">blockAdapActionsTVar</span></a></span></span><span> </span><span id="local-6989586621679299287"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299287"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span></span><span> </span><span id="local-6989586621679299288"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299288"><span class="hs-identifier hs-var">adapActionIS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>        </span><span id="local-6989586621679299289"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299289"><span class="hs-identifier hs-var">blockAdapActions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299286"><span class="hs-identifier hs-var">blockAdapActionsTVar</span></a></span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299289"><span class="hs-identifier hs-var">blockAdapActions</span></a></span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (IOAct i o) -&gt; [Maybe (IOAct i o)]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">singleton</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IOAct i o) -&gt; [Maybe (IOAct i o)])
-&gt; STM (Maybe (IOAct i o)) -&gt; STM [Maybe (IOAct i o)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a. TInputStream a -&gt; STM (Maybe a)
</span><a href="System.IO.Streams.Synchronized.html#read"><span class="hs-identifier hs-var">Streams.read</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299287"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span><span> </span><span class="hs-comment">-- adap actions are blocked, so observe just the loopback actions</span><span>
</span><span id="line-214"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o) -&gt; STM [Maybe (IOAct i o)]
forall i o.
TInputStream (IOAct i o)
-&gt; TInputStream (IOAct i o) -&gt; STM [Maybe (IOAct i o)]
</span><a href="Lattest.Adapter.StandardAdapters.html#mergeActions"><span class="hs-identifier hs-var">mergeActions</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299287"><span class="hs-identifier hs-var">loopbackActionIS</span></a></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299288"><span class="hs-identifier hs-var">adapActionIS</span></a></span><span> </span><span class="hs-comment">-- adap actions are not blocked, merge actions as normal</span><span>
</span><span id="line-215"></span><span>    </span><span id="local-6989586621679298873"><span class="annot"><a href="#local-6989586621679299282"><span class="hs-identifier hs-type">duplicateHandlingIncompleteness</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#InputAttempt"><span class="hs-identifier hs-type">InputAttempt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298873"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="#local-6989586621679298873"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="#local-6989586621679298873"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-216"></span><span>    </span><span id="local-6989586621679299282"><span class="annot"><span class="annottext">duplicateHandlingIncompleteness :: forall i.
TVar Bool
-&gt; OutputStream (InputAttempt i)
-&gt; OutputStream i
-&gt; IO (OutputStream i)
</span><a href="#local-6989586621679299282"><span class="hs-identifier hs-var hs-var">duplicateHandlingIncompleteness</span></a></span></span><span> </span><span id="local-6989586621679299294"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299294"><span class="hs-identifier hs-var">isAdapOutputBlocked</span></a></span></span><span> </span><span id="local-6989586621679299295"><span class="annot"><span class="annottext">OutputStream (InputAttempt i)
</span><a href="#local-6989586621679299295"><span class="hs-identifier hs-var">loopbackInputOS</span></a></span></span><span> </span><span id="local-6989586621679299296"><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299296"><span class="hs-identifier hs-var">adapInputOS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe i -&gt; IO ()) -&gt; IO (OutputStream i)
forall a. (Maybe a -&gt; IO ()) -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">makeOutputStream</span></span><span> </span><span class="annot"><span class="annottext">((Maybe i -&gt; IO ()) -&gt; IO (OutputStream i))
-&gt; (Maybe i -&gt; IO ()) -&gt; IO (OutputStream i)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299297"><span class="annot"><span class="annottext">Maybe i
</span><a href="#local-6989586621679299297"><span class="hs-identifier hs-var">mi</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe i
</span><a href="#local-6989586621679299297"><span class="hs-identifier hs-var">mi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-218"></span><span>            </span><span class="annot"><span class="annottext">Maybe i
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (InputAttempt i) -&gt; OutputStream (InputAttempt i) -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe (InputAttempt i)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">OutputStream (InputAttempt i)
</span><a href="#local-6989586621679299295"><span class="hs-identifier hs-var">loopbackInputOS</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe i -&gt; OutputStream i -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe i
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299296"><span class="hs-identifier hs-var">adapInputOS</span></a></span><span>
</span><span id="line-219"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299298"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299298"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299294"><span class="hs-identifier hs-var">isAdapOutputBlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-221"></span><span>                </span><span id="local-6989586621679299299"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299299"><span class="hs-identifier hs-var">inputSucceeded</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputStream i -&gt; i -&gt; IO Bool
forall i. OutputStream i -&gt; i -&gt; IO Bool
</span><a href="#local-6989586621679299300"><span class="hs-identifier hs-var">attemptInputToAdap</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299296"><span class="hs-identifier hs-var">adapInputOS</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299298"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-222"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299301"><span class="annot"><span class="annottext">mInputAction :: Maybe (InputAttempt i)
</span><a href="#local-6989586621679299301"><span class="hs-identifier hs-var hs-var">mInputAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InputAttempt i -&gt; Maybe (InputAttempt i)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(InputAttempt i -&gt; Maybe (InputAttempt i))
-&gt; InputAttempt i -&gt; Maybe (InputAttempt i)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(i, Bool) -&gt; InputAttempt i
forall i. (i, Bool) -&gt; InputAttempt i
</span><a href="Lattest.Model.Alphabet.html#InputAttempt"><span class="hs-identifier hs-var">InputAttempt</span></a></span><span class="hs-special">(</span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299298"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299299"><span class="hs-identifier hs-var">inputSucceeded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>                </span><span class="annot"><span class="annottext">Maybe (InputAttempt i) -&gt; OutputStream (InputAttempt i) -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe (InputAttempt i)
</span><a href="#local-6989586621679299301"><span class="hs-identifier hs-var">mInputAction</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream (InputAttempt i)
</span><a href="#local-6989586621679299295"><span class="hs-identifier hs-var">loopbackInputOS</span></a></span><span>
</span><span id="line-224"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299294"><span class="hs-identifier hs-var">isAdapOutputBlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621679298884"><span class="annot"><a href="#local-6989586621679299300"><span class="hs-identifier hs-type">attemptInputToAdap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="#local-6989586621679298884"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298884"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621679299300"><span class="annot"><span class="annottext">attemptInputToAdap :: forall i. OutputStream i -&gt; i -&gt; IO Bool
</span><a href="#local-6989586621679299300"><span class="hs-identifier hs-var hs-var">attemptInputToAdap</span></a></span></span><span> </span><span id="local-6989586621679299307"><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299307"><span class="hs-identifier hs-var">adapInputOS</span></a></span></span><span> </span><span id="local-6989586621679299308"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299308"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatternMatchFail -&gt; IO Bool) -&gt; IO Bool -&gt; IO Bool
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i -&gt; PatternMatchFail -&gt; IO Bool
forall i. i -&gt; PatternMatchFail -&gt; IO Bool
</span><a href="#local-6989586621679299309"><span class="hs-identifier hs-var">patternMatchHandler</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299308"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe i -&gt; OutputStream i -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i -&gt; Maybe i
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299308"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299307"><span class="hs-identifier hs-var">adapInputOS</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Bool -&gt; IO Bool
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621679298891"><span class="annot"><a href="#local-6989586621679299309"><span class="hs-identifier hs-type">patternMatchHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679298891"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PatternMatchFail</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621679299309"><span class="annot"><span class="annottext">patternMatchHandler :: forall i. i -&gt; PatternMatchFail -&gt; IO Bool
</span><a href="#local-6989586621679299309"><span class="hs-identifier hs-var hs-var">patternMatchHandler</span></a></span></span><span> </span><span id="local-6989586621679299311"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299311"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="annot"><span class="annottext">PatternMatchFail
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="annot"><span class="hs-comment">-- | adapter which, after every input, directly sends the corresponding sequence of outputs</span></span><span>
</span><span id="line-232"></span><span id="local-6989586621679298893"><span id="local-6989586621679298894"><span id="local-6989586621679298895"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#pureMealyAdapter"><span class="hs-identifier hs-type">pureMealyAdapter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679298893"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298894"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298893"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679298893"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298894"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679298895"><span class="hs-identifier hs-type">act</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298893"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298895"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298894"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-233"></span><span class="hs-comment">-- FIXME this should also implicitly observe the accepted inputs, for which it probably needs to send either (IOAct i o) or (i/o) instead of an abstract act</span><span>
</span><span id="line-234"></span><span id="pureMealyAdapter"><span class="annot"><span class="annottext">pureMealyAdapter :: forall state i act.
(state -&gt; i -&gt; state)
-&gt; (state -&gt; i -&gt; [act]) -&gt; state -&gt; IO (Adapter act i)
</span><a href="Lattest.Adapter.StandardAdapters.html#pureMealyAdapter"><span class="hs-identifier hs-var hs-var">pureMealyAdapter</span></a></span></span><span> </span><span id="local-6989586621679299322"><span class="annot"><span class="annottext">state -&gt; i -&gt; state
</span><a href="#local-6989586621679299322"><span class="hs-identifier hs-var">transitionFunction</span></a></span></span><span> </span><span id="local-6989586621679299323"><span class="annot"><span class="annottext">state -&gt; i -&gt; [act]
</span><a href="#local-6989586621679299323"><span class="hs-identifier hs-var">outputFunction</span></a></span></span><span> </span><span id="local-6989586621679299324"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299324"><span class="hs-identifier hs-var">initialState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621679299325"><span class="annot"><span class="annottext">TVar state
</span><a href="#local-6989586621679299325"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">state -&gt; IO (TVar state)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299324"><span class="hs-identifier hs-var">initialState</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span id="local-6989586621679299326"><span class="annot"><span class="annottext">TQueue (Maybe act)
</span><a href="#local-6989586621679299326"><span class="hs-identifier hs-var">outputQueue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TQueue (Maybe act))
forall a. IO (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621679299327"><span class="annot"><span class="annottext">TInputStream act
</span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe act) -&gt; IO (TInputStream act)
forall a. TQueue (Maybe a) -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#fromBuffer"><span class="hs-identifier hs-var">fromBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe act)
</span><a href="#local-6989586621679299326"><span class="hs-identifier hs-var">outputQueue</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span id="local-6989586621679299328"><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299328"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Maybe i -&gt; IO ()) -&gt; IO (OutputStream i)
forall a. (Maybe a -&gt; IO ()) -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">makeOutputStream</span></span><span> </span><span class="annot"><span class="annottext">((Maybe i -&gt; IO ()) -&gt; IO (OutputStream i))
-&gt; (Maybe i -&gt; IO ()) -&gt; IO (OutputStream i)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299329"><span class="annot"><span class="annottext">Maybe i
</span><a href="#local-6989586621679299329"><span class="hs-identifier hs-var">mi</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe i
</span><a href="#local-6989586621679299329"><span class="hs-identifier hs-var">mi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-240"></span><span>            </span><span class="annot"><span class="annottext">Maybe i
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe act) -&gt; Maybe act -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe act)
</span><a href="#local-6989586621679299326"><span class="hs-identifier hs-var">outputQueue</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe act
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299330"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299330"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>                </span><span id="local-6989586621679299331"><span class="annot"><span class="annottext">[act]
</span><a href="#local-6989586621679299331"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar state -&gt; i -&gt; IO [act]
</span><a href="#local-6989586621679299332"><span class="hs-identifier hs-var">transduce</span></a></span><span> </span><span class="annot"><span class="annottext">TVar state
</span><a href="#local-6989586621679299325"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299330"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-244"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[STM ()] -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue (Maybe act) -&gt; Maybe act -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe act)
</span><a href="#local-6989586621679299326"><span class="hs-identifier hs-var">outputQueue</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe act -&gt; STM ()) -&gt; (act -&gt; Maybe act) -&gt; act -&gt; STM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">act -&gt; Maybe act
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(act -&gt; STM ()) -&gt; [act] -&gt; [STM ()]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[act]
</span><a href="#local-6989586621679299331"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">Adapter act i -&gt; IO (Adapter act i)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Adapter act i -&gt; IO (Adapter act i))
-&gt; Adapter act i -&gt; IO (Adapter act i)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-246"></span><span>        </span><span class="annot"><span class="annottext">inputCommandsToSut :: OutputStream i
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputStream i
</span><a href="#local-6989586621679299328"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-247"></span><span>        </span><span class="annot"><span class="annottext">actionsFromSut :: TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TInputStream act
</span><a href="#local-6989586621679299327"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">close :: IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-251"></span><span>    </span><span id="local-6989586621679299332"><span class="annot"><span class="annottext">transduce :: TVar state -&gt; i -&gt; IO [act]
</span><a href="#local-6989586621679299332"><span class="hs-identifier hs-var hs-var">transduce</span></a></span></span><span> </span><span id="local-6989586621679299336"><span class="annot"><span class="annottext">TVar state
</span><a href="#local-6989586621679299336"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679299337"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299337"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM [act] -&gt; IO [act]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [act] -&gt; IO [act]) -&gt; STM [act] -&gt; IO [act]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>        </span><span id="local-6989586621679299338"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299338"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar state -&gt; STM state
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar state
</span><a href="#local-6989586621679299336"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-253"></span><span>        </span><span class="annot"><span class="annottext">TVar state -&gt; state -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar state
</span><a href="#local-6989586621679299336"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">state -&gt; i -&gt; state
</span><a href="#local-6989586621679299322"><span class="hs-identifier hs-var">transitionFunction</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299338"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299337"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>        </span><span class="annot"><span class="annottext">[act] -&gt; STM [act]
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([act] -&gt; STM [act]) -&gt; [act] -&gt; STM [act]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">state -&gt; i -&gt; [act]
</span><a href="#local-6989586621679299323"><span class="hs-identifier hs-var">outputFunction</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299338"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299337"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span class="annot"><span class="hs-comment">{-|
    Adapter which, after every action, has the given probability of producing non-deterministically one of the corresponding (non-timeout) output transitions if any is available.
    After receiving a Nothing input, an output will be produced, which may be a timeout.
-}</span></span><span>
</span><span id="line-260"></span><span id="local-6989586621679298903"><span id="local-6989586621679298904"><span id="local-6989586621679298905"><span id="local-6989586621679298907"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#pureAdapter"><span class="hs-identifier hs-type">pureAdapter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679298903"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679298904"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RandomGen</span></span><span> </span><span class="annot"><a href="#local-6989586621679298905"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298905"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679298907"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298903"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298904"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679298907"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679298907"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#SuspendedIF"><span class="hs-identifier hs-type">SuspendedIF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298903"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298904"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679298903"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-261"></span><span id="pureAdapter"><span class="annot"><span class="annottext">pureAdapter :: forall i o g state.
(Ord i, Ord o, RandomGen g) =&gt;
g
-&gt; Double
-&gt; (state -&gt; Map (IOAct i o) state)
-&gt; state
-&gt; IO (Adapter (SuspendedIF i o) (Maybe i))
</span><a href="Lattest.Adapter.StandardAdapters.html#pureAdapter"><span class="hs-identifier hs-var hs-var">pureAdapter</span></a></span></span><span> </span><span id="local-6989586621679299359"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621679299359"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679299360"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679299360"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679299361"><span class="annot"><span class="annottext">state -&gt; Map (IOAct i o) state
</span><a href="#local-6989586621679299361"><span class="hs-identifier hs-var">transitionFunction</span></a></span></span><span> </span><span id="local-6989586621679299362"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299362"><span class="hs-identifier hs-var">initialState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679299364"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621679299364"><span class="hs-identifier hs-var">g'</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679299365"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299365"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299366"><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
</span><a href="#local-6989586621679299366"><span class="hs-identifier hs-var">outs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(state -&gt; Map (IOAct i o) state)
-&gt; g -&gt; state -&gt; Bool -&gt; ((g, state), [IOAct i (Suspended o)])
forall {a} {b} {i} {o} {i}.
RandomGen a =&gt;
(b -&gt; Map (IOAct i o) b)
-&gt; a -&gt; b -&gt; Bool -&gt; ((a, b), [IOAct i (Suspended o)])
</span><a href="#local-6989586621679299367"><span class="hs-identifier hs-var">randomOutputTransitions</span></a></span><span> </span><span class="annot"><span class="annottext">state -&gt; Map (IOAct i o) state
</span><a href="#local-6989586621679299361"><span class="hs-identifier hs-var">transitionFunction</span></a></span><span> </span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621679299359"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299362"><span class="hs-identifier hs-var">initialState</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- immediately take some outputs at the start</span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621679299368"><span class="annot"><span class="annottext">Maybe i -&gt; IO [SuspendedIF i o]
</span><a href="#local-6989586621679299368"><span class="hs-identifier hs-var">statefulAdapter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((g, state) -&gt; Maybe i -&gt; ((g, state), [SuspendedIF i o]))
-&gt; (g, state) -&gt; IO (Maybe i -&gt; IO [SuspendedIF i o])
forall q i o. (q -&gt; i -&gt; (q, o)) -&gt; q -&gt; IO (i -&gt; IO o)
</span><a href="Lattest.Util.IOUtils.html#statefulIO%27"><span class="hs-identifier hs-var">statefulIO'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(state -&gt; Map (IOAct i o) state)
-&gt; (g, state) -&gt; Maybe i -&gt; ((g, state), [SuspendedIF i o])
forall {a} {i} {o} {a}.
(RandomGen a, Ord i, Ord o) =&gt;
(a -&gt; Map (IOAct i o) a)
-&gt; (a, a)
-&gt; Maybe i
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
</span><a href="#local-6989586621679299369"><span class="hs-identifier hs-var">processInput</span></a></span><span> </span><span class="annot"><span class="annottext">state -&gt; Map (IOAct i o) state
</span><a href="#local-6989586621679299361"><span class="hs-identifier hs-var">transitionFunction</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621679299364"><span class="hs-identifier hs-var">g'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679299365"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>    </span><span id="local-6989586621679299370"><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
</span><a href="#local-6989586621679299370"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TQueue (Maybe (SuspendedIF i o)))
forall a. IO (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[STM ()] -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
-&gt; Maybe (SuspendedIF i o) -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
</span><a href="#local-6989586621679299370"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SuspendedIF i o) -&gt; STM ())
-&gt; (SuspendedIF i o -&gt; Maybe (SuspendedIF i o))
-&gt; SuspendedIF i o
-&gt; STM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SuspendedIF i o -&gt; Maybe (SuspendedIF i o)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(SuspendedIF i o -&gt; STM ()) -&gt; [SuspendedIF i o] -&gt; [STM ()]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SuspendedIF i o]
forall {i}. [IOAct i (Suspended o)]
</span><a href="#local-6989586621679299366"><span class="hs-identifier hs-var">outs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>    </span><span id="local-6989586621679299371"><span class="annot"><span class="annottext">TInputStream (SuspendedIF i o)
</span><a href="#local-6989586621679299371"><span class="hs-identifier hs-var">inputStream</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
-&gt; IO (TInputStream (SuspendedIF i o))
forall a. TQueue (Maybe a) -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#fromBuffer"><span class="hs-identifier hs-var">fromBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
</span><a href="#local-6989586621679299370"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span id="local-6989586621679299372"><span class="annot"><span class="annottext">OutputStream (Maybe i)
</span><a href="#local-6989586621679299372"><span class="hs-identifier hs-var">outputStream</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Maybe (Maybe i) -&gt; IO ()) -&gt; IO (OutputStream (Maybe i))
forall a. (Maybe a -&gt; IO ()) -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">makeOutputStream</span></span><span> </span><span class="annot"><span class="annottext">((Maybe (Maybe i) -&gt; IO ()) -&gt; IO (OutputStream (Maybe i)))
-&gt; (Maybe (Maybe i) -&gt; IO ()) -&gt; IO (OutputStream (Maybe i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299373"><span class="annot"><span class="annottext">Maybe (Maybe i)
</span><a href="#local-6989586621679299373"><span class="hs-identifier hs-var">mi</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe i)
</span><a href="#local-6989586621679299373"><span class="hs-identifier hs-var">mi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-269"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Maybe i)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
-&gt; Maybe (SuspendedIF i o) -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
</span><a href="#local-6989586621679299370"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SuspendedIF i o)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-271"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299374"><span class="annot"><span class="annottext">Maybe i
</span><a href="#local-6989586621679299374"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>                </span><span id="local-6989586621679299375"><span class="annot"><span class="annottext">[SuspendedIF i o]
</span><a href="#local-6989586621679299375"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe i -&gt; IO [SuspendedIF i o]
</span><a href="#local-6989586621679299368"><span class="hs-identifier hs-var">statefulAdapter</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe i
</span><a href="#local-6989586621679299374"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-273"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[STM ()] -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
-&gt; Maybe (SuspendedIF i o) -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (SuspendedIF i o))
</span><a href="#local-6989586621679299370"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SuspendedIF i o) -&gt; STM ())
-&gt; (SuspendedIF i o -&gt; Maybe (SuspendedIF i o))
-&gt; SuspendedIF i o
-&gt; STM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SuspendedIF i o -&gt; Maybe (SuspendedIF i o)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(SuspendedIF i o -&gt; STM ()) -&gt; [SuspendedIF i o] -&gt; [STM ()]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SuspendedIF i o]
</span><a href="#local-6989586621679299375"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="annottext">Adapter (SuspendedIF i o) (Maybe i)
-&gt; IO (Adapter (SuspendedIF i o) (Maybe i))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Adapter (SuspendedIF i o) (Maybe i)
 -&gt; IO (Adapter (SuspendedIF i o) (Maybe i)))
-&gt; Adapter (SuspendedIF i o) (Maybe i)
-&gt; IO (Adapter (SuspendedIF i o) (Maybe i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><span class="annottext">inputCommandsToSut :: OutputStream (Maybe i)
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputStream (Maybe i)
</span><a href="#local-6989586621679299372"><span class="hs-identifier hs-var">outputStream</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-276"></span><span>        </span><span class="annot"><span class="annottext">actionsFromSut :: TInputStream (SuspendedIF i o)
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TInputStream (SuspendedIF i o)
</span><a href="#local-6989586621679299371"><span class="hs-identifier hs-var">inputStream</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">close :: IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-comment">--processInput :: (Ord i, Ord o, RandomGen g) =&gt; (q -&gt; Map.Map (IOAct i o) q) -&gt; (g, q) -&gt; Maybe i -&gt; ((g, q), [Suspended o])</span><span>
</span><span id="line-281"></span><span>        </span><span id="local-6989586621679299369"><span class="annot"><span class="annottext">processInput :: (a -&gt; Map (IOAct i o) a)
-&gt; (a, a)
-&gt; Maybe i
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
</span><a href="#local-6989586621679299369"><span class="hs-identifier hs-var hs-var">processInput</span></a></span></span><span> </span><span id="local-6989586621679299390"><span class="annot"><span class="annottext">a -&gt; Map (IOAct i o) a
</span><a href="#local-6989586621679299390"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299391"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299391"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299392"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299392"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe i
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Map (IOAct i o) a)
-&gt; a
-&gt; a
-&gt; Bool
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
forall {a} {b} {i} {o} {i}.
RandomGen a =&gt;
(b -&gt; Map (IOAct i o) b)
-&gt; a -&gt; b -&gt; Bool -&gt; ((a, b), [IOAct i (Suspended o)])
</span><a href="#local-6989586621679299367"><span class="hs-identifier hs-var">randomOutputTransitions</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Map (IOAct i o) a
</span><a href="#local-6989586621679299390"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299391"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299392"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><a href="#local-6989586621679299369"><span class="hs-identifier hs-var">processInput</span></a></span><span> </span><span id="local-6989586621679299393"><span class="annot"><span class="annottext">a -&gt; Map (IOAct i o) a
</span><a href="#local-6989586621679299393"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299394"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299394"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299395"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299395"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299396"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299396"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IOAct i o -&gt; Map (IOAct i o) a -&gt; Maybe a
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i -&gt; IOAct i o
forall i o. i -&gt; IOAct i o
</span><a href="Lattest.Model.Alphabet.html#In"><span class="hs-identifier hs-var">In</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299396"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Map (IOAct i o) a
</span><a href="#local-6989586621679299393"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299395"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-283"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299398"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299398"><span class="hs-identifier hs-var">q'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InputAttempt i
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
forall {i} {a} {o}. i -&gt; (a, [IOAct i o]) -&gt; (a, [IOAct i o])
</span><a href="#local-6989586621679299399"><span class="hs-identifier hs-var">prependInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(i, Bool) -&gt; InputAttempt i
forall i. (i, Bool) -&gt; InputAttempt i
</span><a href="Lattest.Model.Alphabet.html#InputAttempt"><span class="hs-identifier hs-var">InputAttempt</span></a></span><span class="hs-special">(</span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299396"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((a, a), [IOAct (InputAttempt i) (Suspended o)])
 -&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)]))
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Map (IOAct i o) a)
-&gt; a
-&gt; a
-&gt; Bool
-&gt; ((a, a), [IOAct (InputAttempt i) (Suspended o)])
forall {a} {b} {i} {o} {i}.
RandomGen a =&gt;
(b -&gt; Map (IOAct i o) b)
-&gt; a -&gt; b -&gt; Bool -&gt; ((a, b), [IOAct i (Suspended o)])
</span><a href="#local-6989586621679299367"><span class="hs-identifier hs-var">randomOutputTransitions</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Map (IOAct i o) a
</span><a href="#local-6989586621679299393"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299394"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299398"><span class="hs-identifier hs-var">q'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-284"></span><span>            </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299394"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299395"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">InputAttempt i -&gt; IOAct (InputAttempt i) (Suspended o)
forall i o. i -&gt; IOAct i o
</span><a href="Lattest.Model.Alphabet.html#In"><span class="hs-identifier hs-var">In</span></a></span><span> </span><span class="annot"><span class="annottext">(InputAttempt i -&gt; IOAct (InputAttempt i) (Suspended o))
-&gt; InputAttempt i -&gt; IOAct (InputAttempt i) (Suspended o)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(i, Bool) -&gt; InputAttempt i
forall i. (i, Bool) -&gt; InputAttempt i
</span><a href="Lattest.Model.Alphabet.html#InputAttempt"><span class="hs-identifier hs-var">InputAttempt</span></a></span><span class="hs-special">(</span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299396"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-comment">--randomOutputTransitions :: RandomGen g =&gt; (q -&gt; Map.Map (IOAct i o) q) -&gt; g -&gt; q -&gt; Bool -&gt; ((g, q), [Suspended o])</span><span>
</span><span id="line-286"></span><span>        </span><span id="local-6989586621679299367"><span class="annot"><span class="annottext">randomOutputTransitions :: (b -&gt; Map (IOAct i o) b)
-&gt; a -&gt; b -&gt; Bool -&gt; ((a, b), [IOAct i (Suspended o)])
</span><a href="#local-6989586621679299367"><span class="hs-identifier hs-var hs-var">randomOutputTransitions</span></a></span></span><span> </span><span id="local-6989586621679299401"><span class="annot"><span class="annottext">b -&gt; Map (IOAct i o) b
</span><a href="#local-6989586621679299401"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679299402"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299402"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679299403"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679299403"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679299404"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299404"><span class="hs-identifier hs-var">isAfterNoInput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299406"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299406"><span class="hs-identifier hs-var">g'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299407"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679299407"><span class="hs-identifier hs-var">q'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299408"><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
</span><a href="#local-6989586621679299408"><span class="hs-identifier hs-var">outs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(b -&gt; Map (IOAct i o) b)
-&gt; a
-&gt; b
-&gt; [IOAct i (Suspended o)]
-&gt; Bool
-&gt; (a, b, [IOAct i (Suspended o)])
forall {t} {t} {i} {o} {i}.
RandomGen t =&gt;
(t -&gt; Map (IOAct i o) t)
-&gt; t
-&gt; t
-&gt; [IOAct i (Suspended o)]
-&gt; Bool
-&gt; (t, t, [IOAct i (Suspended o)])
</span><a href="#local-6989586621679299409"><span class="hs-identifier hs-var">randomOutputTransitions'</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Map (IOAct i o) b
</span><a href="#local-6989586621679299401"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299402"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679299403"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299404"><span class="hs-identifier hs-var">isAfterNoInput</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299406"><span class="hs-identifier hs-var">g'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679299407"><span class="hs-identifier hs-var">q'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[IOAct i (Suspended o)] -&gt; [IOAct i (Suspended o)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
forall {i}. [IOAct i (Suspended o)]
</span><a href="#local-6989586621679299408"><span class="hs-identifier hs-var">outs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>        </span><span class="hs-comment">--randomOutputTransitions' :: RandomGen g =&gt; (q -&gt; Map.Map (IOAct i o) q) -&gt; g -&gt; q -&gt; [Suspended o] -&gt; Bool -&gt; (g, q, [Suspended o])</span><span>
</span><span id="line-288"></span><span>        </span><span id="local-6989586621679299409"><span class="annot"><span class="annottext">randomOutputTransitions' :: (t -&gt; Map (IOAct i o) t)
-&gt; t
-&gt; t
-&gt; [IOAct i (Suspended o)]
-&gt; Bool
-&gt; (t, t, [IOAct i (Suspended o)])
</span><a href="#local-6989586621679299409"><span class="hs-identifier hs-var hs-var">randomOutputTransitions'</span></a></span></span><span> </span><span id="local-6989586621679299412"><span class="annot"><span class="annottext">t -&gt; Map (IOAct i o) t
</span><a href="#local-6989586621679299412"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679299413"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299413"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679299414"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299414"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679299415"><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
</span><a href="#local-6989586621679299415"><span class="hs-identifier hs-var">outs</span></a></span></span><span> </span><span id="local-6989586621679299416"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299416"><span class="hs-identifier hs-var">isAfterNoInput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-289"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299417"><span class="annot"><span class="annottext">ts :: Map (IOAct i o) t
</span><a href="#local-6989586621679299417"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IOAct i o -&gt; t -&gt; Bool) -&gt; Map (IOAct i o) t -&gt; Map (IOAct i o) t
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.filterWithKey</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679299418"><span class="annot"><span class="annottext">IOAct i o
</span><a href="#local-6989586621679299418"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOAct i o -&gt; Bool
forall i o. IOAct i o -&gt; Bool
</span><a href="Lattest.Model.Alphabet.html#isOutput"><span class="hs-identifier hs-var">isOutput</span></a></span><span> </span><span class="annot"><span class="annottext">IOAct i o
</span><a href="#local-6989586621679299418"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; Map (IOAct i o) t
</span><a href="#local-6989586621679299412"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299414"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Map (IOAct i o) t -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.null</span></span><span> </span><span class="annot"><span class="annottext">Map (IOAct i o) t
</span><a href="#local-6989586621679299417"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-comment">-- if no outputs are available at all, </span><span>
</span><span id="line-291"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299416"><span class="hs-identifier hs-var">isAfterNoInput</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299413"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299414"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Suspended o -&gt; IOAct i (Suspended o)
forall i o. o -&gt; IOAct i o
</span><a href="Lattest.Model.Alphabet.html#Out"><span class="hs-identifier hs-var">Out</span></a></span><span> </span><span class="annot"><span class="annottext">Suspended o
forall o. Suspended o
</span><a href="Lattest.Model.Alphabet.html#Quiescence"><span class="hs-identifier hs-var">Quiescence</span></a></span><span> </span><span class="annot"><span class="annottext">IOAct i (Suspended o)
-&gt; [IOAct i (Suspended o)] -&gt; [IOAct i (Suspended o)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
</span><a href="#local-6989586621679299415"><span class="hs-identifier hs-var">outs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299413"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299414"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
</span><a href="#local-6989586621679299415"><span class="hs-identifier hs-var">outs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- then stop producing actions (meaning a timeout or just no more actions, depending on whether a &quot;Nothing&quot; input was previously received)</span><span>
</span><span id="line-292"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299420"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299420"><span class="hs-identifier hs-var">produceOut</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299421"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299421"><span class="hs-identifier hs-var">g'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299416"><span class="hs-identifier hs-var">isAfterNoInput</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299413"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">t -&gt; Double -&gt; (Bool, t)
forall g. RandomGen g =&gt; g -&gt; Double -&gt; (Bool, g)
</span><a href="Lattest.Util.Utils.html#flipCoin"><span class="hs-identifier hs-var">flipCoin</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299413"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679299360"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-comment">-- else decide whether to produce more actions. This is mandatory if a &quot;Nothing&quot; input was previously received, otherwise flip a coin</span><span>
</span><span id="line-293"></span><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299420"><span class="hs-identifier hs-var">produceOut</span></a></span><span>
</span><span id="line-294"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299421"><span class="hs-identifier hs-var">g'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299414"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
</span><a href="#local-6989586621679299415"><span class="hs-identifier hs-var">outs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- pick a random output, and continue randomly picking more outputs</span><span>
</span><span id="line-296"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679299424"><span class="annot"><span class="annottext">IOAct i o
</span><a href="#local-6989586621679299424"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299425"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299425"><span class="hs-identifier hs-var">q'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299426"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299426"><span class="hs-identifier hs-var">g''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; [(IOAct i o, t)] -&gt; ((IOAct i o, t), t)
forall g a. RandomGen g =&gt; g -&gt; [a] -&gt; (a, g)
</span><a href="Lattest.Util.Utils.html#takeRandom"><span class="hs-identifier hs-var">takeRandom</span></a></span><span>  </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299421"><span class="hs-identifier hs-var">g'</span></a></span><span> </span><span class="annot"><span class="annottext">([(IOAct i o, t)] -&gt; ((IOAct i o, t), t))
-&gt; [(IOAct i o, t)] -&gt; ((IOAct i o, t), t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map (IOAct i o) t -&gt; [(IOAct i o, t)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map (IOAct i o) t
</span><a href="#local-6989586621679299417"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-297"></span><span>                            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(t -&gt; Map (IOAct i o) t)
-&gt; t
-&gt; t
-&gt; [IOAct i (Suspended o)]
-&gt; Bool
-&gt; (t, t, [IOAct i (Suspended o)])
</span><a href="#local-6989586621679299409"><span class="hs-identifier hs-var">randomOutputTransitions'</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; Map (IOAct i o) t
</span><a href="#local-6989586621679299412"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299426"><span class="hs-identifier hs-var">g''</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679299425"><span class="hs-identifier hs-var">q'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Suspended o -&gt; IOAct i (Suspended o)
forall i o. o -&gt; IOAct i o
</span><a href="Lattest.Model.Alphabet.html#Out"><span class="hs-identifier hs-var">Out</span></a></span><span> </span><span class="annot"><span class="annottext">(Suspended o -&gt; IOAct i (Suspended o))
-&gt; Suspended o -&gt; IOAct i (Suspended o)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">o -&gt; Suspended o
forall o. o -&gt; Suspended o
</span><a href="Lattest.Model.Alphabet.html#OutSusp"><span class="hs-identifier hs-var">OutSusp</span></a></span><span> </span><span class="annot"><span class="annottext">(o -&gt; Suspended o) -&gt; o -&gt; Suspended o
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IOAct i o -&gt; o
forall i o. IOAct i o -&gt; o
</span><a href="Lattest.Model.Alphabet.html#fromOutput"><span class="hs-identifier hs-var">fromOutput</span></a></span><span> </span><span class="annot"><span class="annottext">IOAct i o
</span><a href="#local-6989586621679299424"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IOAct i (Suspended o)
-&gt; [IOAct i (Suspended o)] -&gt; [IOAct i (Suspended o)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[IOAct i (Suspended o)]
</span><a href="#local-6989586621679299415"><span class="hs-identifier hs-var">outs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-298"></span><span>        </span><span id="local-6989586621679299399"><span class="annot"><span class="annottext">prependInput :: i -&gt; (a, [IOAct i o]) -&gt; (a, [IOAct i o])
</span><a href="#local-6989586621679299399"><span class="hs-identifier hs-var hs-var">prependInput</span></a></span></span><span> </span><span id="local-6989586621679299428"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299428"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679299429"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299429"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299430"><span class="annot"><span class="annottext">[IOAct i o]
</span><a href="#local-6989586621679299430"><span class="hs-identifier hs-var">acts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679299429"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">i -&gt; IOAct i o
forall i o. i -&gt; IOAct i o
</span><a href="Lattest.Model.Alphabet.html#In"><span class="hs-identifier hs-var">In</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299428"><span class="hs-identifier hs-var">i</span></a></span><span class="annot"><span class="annottext">IOAct i o -&gt; [IOAct i o] -&gt; [IOAct i o]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[IOAct i o]
</span><a href="#local-6989586621679299430"><span class="hs-identifier hs-var">acts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span class="annot"><span class="hs-comment">-- |  Transform the given Adapter by introducing quiescence (timeout observations). See 'withQuiescence', where the waiting time given in milliseconds.</span></span><span>
</span><span id="line-301"></span><span id="local-6989586621679298957"><span id="local-6989586621679298958"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withQuiescenceMillis"><span class="hs-identifier hs-type">withQuiescenceMillis</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298957"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298958"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679298957"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOSuspAct"><span class="hs-identifier hs-type">IOSuspAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298957"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298958"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679298957"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-302"></span><span id="withQuiescenceMillis"><span class="annot"><span class="annottext">withQuiescenceMillis :: forall i o.
Int
-&gt; Adapter (IOAct i o) i -&gt; IO (Adapter (IOSuspAct i o) (Maybe i))
</span><a href="Lattest.Adapter.StandardAdapters.html#withQuiescenceMillis"><span class="hs-identifier hs-var hs-var">withQuiescenceMillis</span></a></span></span><span> </span><span id="local-6989586621679299440"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299440"><span class="hs-identifier hs-var">timeoutMillis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
-&gt; Adapter (IOAct i o) i -&gt; IO (Adapter (IOSuspAct i o) (Maybe i))
forall i o.
NominalDiffTime
-&gt; Adapter (IOAct i o) i -&gt; IO (Adapter (IOSuspAct i o) (Maybe i))
</span><a href="Lattest.Adapter.StandardAdapters.html#withQuiescence"><span class="hs-identifier hs-var">withQuiescence</span></a></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime
 -&gt; Adapter (IOAct i o) i -&gt; IO (Adapter (IOSuspAct i o) (Maybe i)))
-&gt; NominalDiffTime
-&gt; Adapter (IOAct i o) i
-&gt; IO (Adapter (IOSuspAct i o) (Maybe i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">secondsToNominalDiffTime</span></span><span> </span><span class="annot"><span class="annottext">(Pico -&gt; NominalDiffTime) -&gt; Pico -&gt; NominalDiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico
</span><span class="hs-number">0.001</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; Pico -&gt; Pico
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Pico
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299440"><span class="hs-identifier hs-var">timeoutMillis</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span class="annot"><span class="hs-comment">{-|
    Transform the given Adapter by introducing quiescence (timeout observations). Inputs can be sent as 'Just' inputs, and 'IOAct' observations can be
    done as in the provided adapter, where the outputs in the 'IOAct' are wrapped in 'SuspAct' to denote that they are real outputs. Additionally:
    
    * An artificial 'Quiescence' output observation is made after the provided timeout value. This timeout is measured since the last 'Just' input or
    'SuspOut' output has been received.
    
    * An artificial 'Nothing' input can be made, which indicates waiting for an output. Sending a 'Nothing' will block until any output is received,
    which may be a real 'SuspAct' output or 'Quiescence'. This is guaranteed to happen within the given timeout value, give or take a few milliseconds
    for processing.
-}</span></span><span>
</span><span id="line-315"></span><span id="local-6989586621679298971"><span id="local-6989586621679298972"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withQuiescence"><span class="hs-identifier hs-type">withQuiescence</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NominalDiffTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298971"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298972"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679298971"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOSuspAct"><span class="hs-identifier hs-type">IOSuspAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298971"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679298972"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679298971"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-316"></span><span id="withQuiescence"><span class="annot"><span class="annottext">withQuiescence :: forall i o.
NominalDiffTime
-&gt; Adapter (IOAct i o) i -&gt; IO (Adapter (IOSuspAct i o) (Maybe i))
</span><a href="Lattest.Adapter.StandardAdapters.html#withQuiescence"><span class="hs-identifier hs-var hs-var">withQuiescence</span></a></span></span><span> </span><span id="local-6989586621679299453"><span class="annot"><span class="annottext">NominalDiffTime
</span><a href="#local-6989586621679299453"><span class="hs-identifier hs-var">timeoutDiff</span></a></span></span><span> </span><span id="local-6989586621679299454"><span class="annot"><span class="annottext">Adapter (IOAct i o) i
</span><a href="#local-6989586621679299454"><span class="hs-identifier hs-var">adap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621679299455"><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299455"><span class="hs-identifier hs-var">lastObservationTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar UTCTime)
forall a. IO (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span> </span><span class="hs-comment">-- time of the last observed action. Nothing if observing hasn't started yet.</span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621679299456"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299456"><span class="hs-identifier hs-var">isProcessingObservation</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (TVar Bool)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621679299457"><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o))
</span><a href="#local-6989586621679299457"><span class="hs-identifier hs-var">observedQueue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TQueue (Maybe (IOSuspAct i o)))
forall a. IO (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299462"><span class="annot"><span class="annottext">ensureObservationTime :: IO ()
</span><a href="#local-6989586621679299462"><span class="hs-identifier hs-var hs-var">ensureObservationTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- start observing, if this hasn't already been done yet</span><span>
</span><span id="line-321"></span><span>            </span><span id="local-6989586621679299463"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299463"><span class="hs-identifier hs-var">isEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; IO Bool
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Bool -&gt; IO Bool) -&gt; STM Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; STM Bool
forall a. TMVar a -&gt; STM Bool
</span><span class="hs-identifier hs-var">isEmptyTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299455"><span class="hs-identifier hs-var">lastObservationTime</span></a></span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a. Applicative m =&gt; Bool -&gt; m a -&gt; m ()
</span><a href="Lattest.Util.IOUtils.html#ifM_"><span class="hs-identifier hs-var">ifM_</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299463"><span class="hs-identifier hs-var">isEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-323"></span><span>                </span><span id="local-6989586621679299464"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299464"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-324"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; UTCTime -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299455"><span class="hs-identifier hs-var">lastObservationTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299464"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-325"></span><span>        </span><span id="local-6989586621679299470"><span class="annot"><span class="annottext">updateObservationTime :: UTCTime -&gt; STM ()
</span><a href="#local-6989586621679299470"><span class="hs-identifier hs-var hs-var">updateObservationTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299471"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299471"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- if the current time is past the stored observation time, then update that observation time to now</span><span>
</span><span id="line-326"></span><span>            </span><span id="local-6989586621679299472"><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621679299472"><span class="hs-identifier hs-var">mLastTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; STM (Maybe UTCTime)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">tryReadTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299455"><span class="hs-identifier hs-var">lastObservationTime</span></a></span><span>
</span><span id="line-327"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621679299472"><span class="hs-identifier hs-var">mLastTime</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-328"></span><span>                </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; UTCTime -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299455"><span class="hs-identifier hs-var">lastObservationTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299471"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-329"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299473"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299473"><span class="hs-identifier hs-var">lastTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (m :: * -&gt; *) a. Applicative m =&gt; Bool -&gt; m a -&gt; m ()
</span><a href="Lattest.Util.IOUtils.html#ifM_"><span class="hs-identifier hs-var">ifM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299473"><span class="hs-identifier hs-var">lastTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299471"><span class="hs-identifier hs-var">currentTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; UTCTime -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299455"><span class="hs-identifier hs-var">lastObservationTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299471"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-330"></span><span>        </span><span id="local-6989586621679299494"><span class="annot"><span class="annottext">getWaitTimeMicros :: UTCTime -&gt; STM Integer
</span><a href="#local-6989586621679299494"><span class="hs-identifier hs-var hs-var">getWaitTimeMicros</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299495"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299495"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- the number of microseconds until the target timeout is reached</span><span>
</span><span id="line-331"></span><span>            </span><span id="local-6989586621679299496"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299496"><span class="hs-identifier hs-var">lastTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; STM UTCTime
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299455"><span class="hs-identifier hs-var">lastObservationTime</span></a></span><span> </span><span class="hs-comment">-- blocking, in case of Nothing</span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299497"><span class="annot"><span class="annottext">targetTime :: UTCTime
</span><a href="#local-6989586621679299497"><span class="hs-identifier hs-var hs-var">targetTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">addUTCTime</span></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><a href="#local-6989586621679299453"><span class="hs-identifier hs-var">timeoutDiff</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299496"><span class="hs-identifier hs-var">lastTime</span></a></span><span>
</span><span id="line-333"></span><span>                </span><span id="local-6989586621679299501"><span class="annot"><span class="annottext">currentTime' :: UTCTime
</span><a href="#local-6989586621679299501"><span class="hs-identifier hs-var hs-var">currentTime'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; UTCTime
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299495"><span class="hs-identifier hs-var">currentTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299496"><span class="hs-identifier hs-var">lastTime</span></a></span><span> </span><span class="hs-comment">-- lastTime &gt; currentTime can occur if the caller waited too long after retrieving the</span><span>
</span><span id="line-334"></span><span>                                                        </span><span class="hs-comment">-- currentTime, in particular when blocking on reading lastObservationTime</span><span>
</span><span id="line-335"></span><span>            </span><span class="annot"><span class="annottext">Integer -&gt; STM Integer
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; STM Integer) -&gt; Integer -&gt; STM Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; Integer
forall b. Integral b =&gt; Pico -&gt; b
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">ceiling</span></span><span> </span><span class="annot"><span class="annottext">(Pico -&gt; Integer) -&gt; Pico -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico
</span><span class="hs-number">1000000</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; Pico -&gt; Pico
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Pico
</span><span class="hs-identifier hs-var">nominalDiffTimeToSeconds</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Pico) -&gt; NominalDiffTime -&gt; Pico
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299497"><span class="hs-identifier hs-var">targetTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299501"><span class="hs-identifier hs-var">currentTime'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>        </span><span id="local-6989586621679299506"><span class="annot"><span class="annottext">waitUntilQuiescence :: IO ()
</span><a href="#local-6989586621679299506"><span class="hs-identifier hs-var hs-var">waitUntilQuiescence</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- wait until the target timeout. Blocks if there is no target timeout yet.</span><span>
</span><span id="line-337"></span><span>            </span><span id="local-6989586621679299507"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299507"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-338"></span><span>            </span><span id="local-6989586621679299508"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679299508"><span class="hs-identifier hs-var">waitTimeMicros</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Integer -&gt; IO Integer
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Integer -&gt; IO Integer) -&gt; STM Integer -&gt; IO Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; STM Integer
</span><a href="#local-6989586621679299494"><span class="hs-identifier hs-var">getWaitTimeMicros</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299507"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-339"></span><span>            </span><span class="annot"><span class="annottext">Integer -&gt; IO ()
</span><span class="hs-identifier hs-var">delay</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679299508"><span class="hs-identifier hs-var">waitTimeMicros</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span id="local-6989586621679299515"><span class="annot"><span class="annottext">quiescenceMonitor :: IO b
</span><a href="#local-6989586621679299515"><span class="hs-identifier hs-var hs-var">quiescenceMonitor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO b) -&gt; IO () -&gt; IO b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- background task that first wait until action monitoring starts, then continuously waits until a timeout</span><span>
</span><span id="line-341"></span><span>                                         </span><span class="hs-comment">-- is reached and sets the quiescence state to true</span><span>
</span><span id="line-342"></span><span>            </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679299506"><span class="hs-identifier hs-var">waitUntilQuiescence</span></a></span><span>
</span><span id="line-343"></span><span>            </span><span id="local-6989586621679299516"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299516"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-344"></span><span>            </span><span class="hs-comment">--quiIsSet &lt;- atomically $ do</span><span>
</span><span id="line-345"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>                </span><span id="local-6989586621679299517"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679299517"><span class="hs-identifier hs-var">additionalWaitTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; STM Integer
</span><a href="#local-6989586621679299494"><span class="hs-identifier hs-var">getWaitTimeMicros</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299516"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-347"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299520"><span class="annot"><span class="annottext">quiescent :: Bool
</span><a href="#local-6989586621679299520"><span class="hs-identifier hs-var hs-var">quiescent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679299517"><span class="hs-identifier hs-var">additionalWaitTime</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-348"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (m :: * -&gt; *) a. Applicative m =&gt; Bool -&gt; m a -&gt; m ()
</span><a href="Lattest.Util.IOUtils.html#ifM_"><span class="hs-identifier hs-var">ifM_</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679299520"><span class="hs-identifier hs-var">quiescent</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>                    </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o)) -&gt; Maybe (IOSuspAct i o) -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o))
</span><a href="#local-6989586621679299457"><span class="hs-identifier hs-var">observedQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOSuspAct i o -&gt; Maybe (IOSuspAct i o)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(IOSuspAct i o -&gt; Maybe (IOSuspAct i o))
-&gt; IOSuspAct i o -&gt; Maybe (IOSuspAct i o)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Suspended o -&gt; IOSuspAct i o
forall i o. o -&gt; IOAct i o
</span><a href="Lattest.Model.Alphabet.html#Out"><span class="hs-identifier hs-var">Out</span></a></span><span> </span><span class="annot"><span class="annottext">Suspended o
forall o. Suspended o
</span><a href="Lattest.Model.Alphabet.html#Quiescence"><span class="hs-identifier hs-var">Quiescence</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>                    </span><span class="annot"><span class="annottext">UTCTime -&gt; STM ()
</span><a href="#local-6989586621679299470"><span class="hs-identifier hs-var">updateObservationTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299516"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-351"></span><span>        </span><span id="local-6989586621679299528"><span class="annot"><span class="annottext">actMonitor :: IO b
</span><a href="#local-6989586621679299528"><span class="hs-identifier hs-var hs-var">actMonitor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO b) -&gt; IO () -&gt; IO b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">--background task that waits for outputs, updates the observation time and unsets the quiescence state</span><span>
</span><span id="line-352"></span><span>            </span><span id="local-6989586621679299529"><span class="annot"><span class="annottext">Maybe (IOAct i o)
</span><a href="#local-6989586621679299529"><span class="hs-identifier hs-var">mAct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (Maybe (IOAct i o)) -&gt; IO (Maybe (IOAct i o))
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe (IOAct i o)) -&gt; IO (Maybe (IOAct i o)))
-&gt; STM (Maybe (IOAct i o)) -&gt; IO (Maybe (IOAct i o))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-353"></span><span>                </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299456"><span class="hs-identifier hs-var">isProcessingObservation</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-354"></span><span>                </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a. TInputStream a -&gt; STM (Maybe a)
</span><a href="System.IO.Streams.Synchronized.html#read"><span class="hs-identifier hs-var">Streams.read</span></a></span><span> </span><span class="annot"><span class="annottext">(TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o)))
-&gt; TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i -&gt; TInputStream (IOAct i o)
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i
</span><a href="#local-6989586621679299454"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-355"></span><span>            </span><span id="local-6989586621679299530"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299530"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-356"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>                </span><span class="hs-comment">-- observation has been made</span><span>
</span><span id="line-358"></span><span>                </span><span class="annot"><span class="annottext">UTCTime -&gt; STM ()
</span><a href="#local-6989586621679299470"><span class="hs-identifier hs-var">updateObservationTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299530"><span class="hs-identifier hs-var">currentTime</span></a></span><span> </span><span class="hs-comment">-- update the observation time</span><span>
</span><span id="line-359"></span><span>                </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299456"><span class="hs-identifier hs-var">isProcessingObservation</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-360"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299533"><span class="annot"><span class="annottext">timedMAct :: Maybe (IOSuspAct i o)
</span><a href="#local-6989586621679299533"><span class="hs-identifier hs-var hs-var">timedMAct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IOAct i o -&gt; IOSuspAct i o
forall i o. IOAct i o -&gt; IOSuspAct i o
</span><a href="Lattest.Model.Alphabet.html#asSuspended"><span class="hs-identifier hs-var">asSuspended</span></a></span><span> </span><span class="annot"><span class="annottext">(IOAct i o -&gt; IOSuspAct i o)
-&gt; Maybe (IOAct i o) -&gt; Maybe (IOSuspAct i o)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IOAct i o)
</span><a href="#local-6989586621679299529"><span class="hs-identifier hs-var">mAct</span></a></span><span>
</span><span id="line-361"></span><span>                </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o)) -&gt; Maybe (IOSuspAct i o) -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o))
</span><a href="#local-6989586621679299457"><span class="hs-identifier hs-var">observedQueue</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IOSuspAct i o)
</span><a href="#local-6989586621679299533"><span class="hs-identifier hs-var">timedMAct</span></a></span><span> </span><span class="hs-comment">-- pass the action to the timeout adapter</span><span>
</span><span id="line-362"></span><span>        </span><span id="local-6989586621679299537"><span class="annot"><span class="annottext">hasObservation :: STM Bool
</span><a href="#local-6989586621679299537"><span class="hs-identifier hs-var hs-var">hasObservation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299456"><span class="hs-identifier hs-var">isProcessingObservation</span></a></span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; STM Bool -&gt; STM Bool
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m Bool -&gt; m Bool
</span><span class="hs-operator hs-var">||^</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; STM Bool -&gt; STM Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o)) -&gt; STM Bool
forall a. TQueue a -&gt; STM Bool
</span><span class="hs-identifier hs-var">isEmptyTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o))
</span><a href="#local-6989586621679299457"><span class="hs-identifier hs-var">observedQueue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; STM Bool -&gt; STM Bool
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m Bool -&gt; m Bool
</span><span class="hs-operator hs-var">||^</span></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM Bool
forall a. TInputStream a -&gt; STM Bool
</span><a href="System.IO.Streams.Synchronized.html#hasInput"><span class="hs-identifier hs-var">hasInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Adapter (IOAct i o) i -&gt; TInputStream (IOAct i o)
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i
</span><a href="#local-6989586621679299454"><span class="hs-identifier hs-var">adap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621679299538"><span class="annot"><span class="annottext">TInputStream (IOSuspAct i o)
</span><a href="#local-6989586621679299538"><span class="hs-identifier hs-var">actionsFromSut'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (Maybe (IOSuspAct i o))
-&gt; STM Bool -&gt; IO (TInputStream (IOSuspAct i o))
forall a. STM (Maybe a) -&gt; STM Bool -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#makeTInputStream"><span class="hs-identifier hs-var">makeTInputStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o)) -&gt; STM (Maybe (IOSuspAct i o))
forall a. TQueue a -&gt; STM a
</span><span class="hs-identifier hs-var">readTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o))
</span><a href="#local-6989586621679299457"><span class="hs-identifier hs-var">observedQueue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM Bool
</span><a href="#local-6989586621679299537"><span class="hs-identifier hs-var">hasObservation</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621679299539"><span class="annot"><span class="annottext">OutputStream (Maybe i)
</span><a href="#local-6989586621679299539"><span class="hs-identifier hs-var">inputCommandsToSut'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Maybe (Maybe i) -&gt; IO ()) -&gt; IO (OutputStream (Maybe i))
forall a. (Maybe a -&gt; IO ()) -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">makeOutputStream</span></span><span> </span><span class="annot"><span class="annottext">((Maybe (Maybe i) -&gt; IO ()) -&gt; IO (OutputStream (Maybe i)))
-&gt; (Maybe (Maybe i) -&gt; IO ()) -&gt; IO (OutputStream (Maybe i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299540"><span class="annot"><span class="annottext">Maybe (Maybe i)
</span><a href="#local-6989586621679299540"><span class="hs-identifier hs-var">mInCmd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679299462"><span class="hs-identifier hs-var">ensureObservationTime</span></a></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe i)
</span><a href="#local-6989586621679299540"><span class="hs-identifier hs-var">mInCmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-367"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299541"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299541"><span class="hs-identifier hs-var">inCmd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe i -&gt; OutputStream i -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i -&gt; Maybe i
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679299541"><span class="hs-identifier hs-var">inCmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OutputStream i -&gt; IO ()) -&gt; OutputStream i -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i -&gt; OutputStream i
forall act i. Adapter act i -&gt; OutputStream i
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i
</span><a href="#local-6989586621679299454"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-368"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Maybe i
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; STM ()
</span><a href="Lattest.Util.IOUtils.html#waitUntil"><span class="hs-identifier hs-var">waitUntil</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Bool -&gt; STM ()) -&gt; STM Bool -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; STM Bool -&gt; STM Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o)) -&gt; STM Bool
forall a. TQueue a -&gt; STM Bool
</span><span class="hs-identifier hs-var">isEmptyTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Maybe (IOSuspAct i o))
</span><a href="#local-6989586621679299457"><span class="hs-identifier hs-var">observedQueue</span></a></span><span> </span><span class="hs-comment">-- Just Nothing input means waiting, on an output or until a timeout</span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Maybe i)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe i -&gt; OutputStream i -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe i
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(OutputStream i -&gt; IO ()) -&gt; OutputStream i -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i -&gt; OutputStream i
forall act i. Adapter act i -&gt; OutputStream i
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i
</span><a href="#local-6989586621679299454"><span class="hs-identifier hs-var">adap</span></a></span><span> </span><span class="hs-comment">-- Nothing means closing the adapter, forward this to the underlying adapter</span><span>
</span><span id="line-370"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
forall {b}. IO b
</span><a href="#local-6989586621679299515"><span class="hs-identifier hs-var">quiescenceMonitor</span></a></span><span>
</span><span id="line-371"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
forall {b}. IO b
</span><a href="#local-6989586621679299528"><span class="hs-identifier hs-var">actMonitor</span></a></span><span>
</span><span id="line-372"></span><span>    </span><span class="annot"><span class="annottext">Adapter (IOSuspAct i o) (Maybe i)
-&gt; IO (Adapter (IOSuspAct i o) (Maybe i))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Adapter (IOSuspAct i o) (Maybe i)
 -&gt; IO (Adapter (IOSuspAct i o) (Maybe i)))
-&gt; Adapter (IOSuspAct i o) (Maybe i)
-&gt; IO (Adapter (IOSuspAct i o) (Maybe i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-373"></span><span>        </span><span class="annot"><span class="annottext">inputCommandsToSut :: OutputStream (Maybe i)
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputStream (Maybe i)
</span><a href="#local-6989586621679299539"><span class="hs-identifier hs-var">inputCommandsToSut'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><span class="annottext">actionsFromSut :: TInputStream (IOSuspAct i o)
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOSuspAct i o)
</span><a href="#local-6989586621679299538"><span class="hs-identifier hs-var">actionsFromSut'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-375"></span><span>        </span><span class="annot"><span class="annottext">close :: IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679299462"><span class="hs-identifier hs-var">ensureObservationTime</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i -&gt; IO ()
forall act i. Adapter act i -&gt; IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i
</span><a href="#local-6989586621679299454"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="annot"><span class="hs-comment">-- | Transform the given Adapter by introducing a short delay after every provided input. See 'withInputDelay', where the delay time given in milliseconds.</span></span><span>
</span><span id="line-379"></span><span id="local-6989586621679299000"><span id="local-6989586621679299001"><span id="local-6989586621679299002"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withInputDelayMillis"><span class="hs-identifier hs-type">withInputDelayMillis</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299000"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299001"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299002"><span class="hs-identifier hs-type">i'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299000"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299001"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299002"><span class="hs-identifier hs-type">i'</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-380"></span><span id="withInputDelayMillis"><span class="annot"><span class="annottext">withInputDelayMillis :: forall i o i'.
Int -&gt; Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i')
</span><a href="Lattest.Adapter.StandardAdapters.html#withInputDelayMillis"><span class="hs-identifier hs-var hs-var">withInputDelayMillis</span></a></span></span><span> </span><span id="local-6989586621679299547"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299547"><span class="hs-identifier hs-var">timeDelayMillis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
-&gt; Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i')
forall i o i'.
NominalDiffTime
-&gt; Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i')
</span><a href="Lattest.Adapter.StandardAdapters.html#withInputDelay"><span class="hs-identifier hs-var">withInputDelay</span></a></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime
 -&gt; Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i'))
-&gt; NominalDiffTime
-&gt; Adapter (IOAct i o) i'
-&gt; IO (Adapter (IOAct i o) i')
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">secondsToNominalDiffTime</span></span><span> </span><span class="annot"><span class="annottext">(Pico -&gt; NominalDiffTime) -&gt; Pico -&gt; NominalDiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico
</span><span class="hs-number">0.001</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; Pico -&gt; Pico
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Pico
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679299547"><span class="hs-identifier hs-var">timeDelayMillis</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="annot"><span class="hs-comment">{-|
    Transform the given Adapter by introducing a short delay after every provided input. After an input is provided, then observing the adapter (or
    even calling `hasObservation`) will block until the specified time duration has passed, or until an output is observed, or until the action stream
    of the adapter closes, whichever comes first.
    
    This may be used to slow down a tester which performs inputs too fast for observation responses to occur.
-}</span></span><span>
</span><span id="line-389"></span><span id="local-6989586621679299006"><span id="local-6989586621679299007"><span id="local-6989586621679299008"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#withInputDelay"><span class="hs-identifier hs-type">withInputDelay</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NominalDiffTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299006"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299007"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299008"><span class="hs-identifier hs-type">i'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299006"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299007"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299008"><span class="hs-identifier hs-type">i'</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-390"></span><span id="withInputDelay"><span class="annot"><span class="annottext">withInputDelay :: forall i o i'.
NominalDiffTime
-&gt; Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i')
</span><a href="Lattest.Adapter.StandardAdapters.html#withInputDelay"><span class="hs-identifier hs-var hs-var">withInputDelay</span></a></span></span><span> </span><span id="local-6989586621679299561"><span class="annot"><span class="annottext">NominalDiffTime
</span><a href="#local-6989586621679299561"><span class="hs-identifier hs-var">timeDelayDiff</span></a></span></span><span> </span><span id="local-6989586621679299562"><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-391"></span><span>    </span><span id="local-6989586621679299563"><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299563"><span class="hs-identifier hs-var">lastInputTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar UTCTime)
forall a. IO (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-392"></span><span>    </span><span id="local-6989586621679299564"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (TVar Bool)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299568"><span class="annot"><span class="annottext">updateInputTime :: UTCTime -&gt; STM ()
</span><a href="#local-6989586621679299568"><span class="hs-identifier hs-var hs-var">updateInputTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299569"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299569"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- if the current time is past the stored input time, then update that observation time to now</span><span>
</span><span id="line-394"></span><span>            </span><span id="local-6989586621679299570"><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621679299570"><span class="hs-identifier hs-var">mLastTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; STM (Maybe UTCTime)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">tryReadTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299563"><span class="hs-identifier hs-var">lastInputTime</span></a></span><span>
</span><span id="line-395"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621679299570"><span class="hs-identifier hs-var">mLastTime</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-396"></span><span>                </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; UTCTime -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299563"><span class="hs-identifier hs-var">lastInputTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299569"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-397"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299571"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299571"><span class="hs-identifier hs-var">lastTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (m :: * -&gt; *) a. Applicative m =&gt; Bool -&gt; m a -&gt; m ()
</span><a href="Lattest.Util.IOUtils.html#ifM_"><span class="hs-identifier hs-var">ifM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299571"><span class="hs-identifier hs-var">lastTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299569"><span class="hs-identifier hs-var">currentTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; UTCTime -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299563"><span class="hs-identifier hs-var">lastInputTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299569"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-398"></span><span>        </span><span id="local-6989586621679299584"><span class="annot"><span class="annottext">getWaitTimeMicros :: UTCTime -&gt; STM Integer
</span><a href="#local-6989586621679299584"><span class="hs-identifier hs-var hs-var">getWaitTimeMicros</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299585"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299585"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- the number of microseconds until the target timeout is reached</span><span>
</span><span id="line-399"></span><span>            </span><span id="local-6989586621679299586"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299586"><span class="hs-identifier hs-var">lastTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; STM UTCTime
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299563"><span class="hs-identifier hs-var">lastInputTime</span></a></span><span> </span><span class="hs-comment">-- should never be nothing, the unblocker ensures this</span><span>
</span><span id="line-400"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679299587"><span class="annot"><span class="annottext">targetTime :: UTCTime
</span><a href="#local-6989586621679299587"><span class="hs-identifier hs-var hs-var">targetTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; UTCTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">addUTCTime</span></span><span> </span><span class="annot"><span class="annottext">NominalDiffTime
</span><a href="#local-6989586621679299561"><span class="hs-identifier hs-var">timeDelayDiff</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299586"><span class="hs-identifier hs-var">lastTime</span></a></span><span>
</span><span id="line-401"></span><span>                </span><span id="local-6989586621679299590"><span class="annot"><span class="annottext">currentTime' :: UTCTime
</span><a href="#local-6989586621679299590"><span class="hs-identifier hs-var hs-var">currentTime'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; UTCTime
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299585"><span class="hs-identifier hs-var">currentTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299586"><span class="hs-identifier hs-var">lastTime</span></a></span><span> </span><span class="hs-comment">-- lastTime &gt; currentTime can occur if the caller waited too long after retrieving the</span><span>
</span><span id="line-402"></span><span>                                                        </span><span class="hs-comment">-- currentTime, in particular when blocking on reading lastObservationTime</span><span>
</span><span id="line-403"></span><span>            </span><span class="annot"><span class="annottext">Integer -&gt; STM Integer
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; STM Integer) -&gt; Integer -&gt; STM Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; Integer
forall b. Integral b =&gt; Pico -&gt; b
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">ceiling</span></span><span> </span><span class="annot"><span class="annottext">(Pico -&gt; Integer) -&gt; Pico -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pico
</span><span class="hs-number">1000000</span></span><span> </span><span class="annot"><span class="annottext">Pico -&gt; Pico -&gt; Pico
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Pico
</span><span class="hs-identifier hs-var">nominalDiffTimeToSeconds</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Pico) -&gt; NominalDiffTime -&gt; Pico
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299587"><span class="hs-identifier hs-var">targetTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299590"><span class="hs-identifier hs-var">currentTime'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>        </span><span id="local-6989586621679299598"><span class="annot"><span class="annottext">waitUntilDelay :: IO ()
</span><a href="#local-6989586621679299598"><span class="hs-identifier hs-var hs-var">waitUntilDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-405"></span><span>            </span><span id="local-6989586621679299599"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299599"><span class="hs-identifier hs-var">inputTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM UTCTime -&gt; IO UTCTime
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM UTCTime -&gt; IO UTCTime) -&gt; STM UTCTime -&gt; IO UTCTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime -&gt; STM UTCTime
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar UTCTime
</span><a href="#local-6989586621679299563"><span class="hs-identifier hs-var">lastInputTime</span></a></span><span>
</span><span id="line-406"></span><span>            </span><span id="local-6989586621679299600"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299600"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-407"></span><span>            </span><span id="local-6989586621679299601"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679299601"><span class="hs-identifier hs-var">waitTimeMicros</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Integer -&gt; IO Integer
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Integer -&gt; IO Integer) -&gt; STM Integer -&gt; IO Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; STM Integer
</span><a href="#local-6989586621679299584"><span class="hs-identifier hs-var">getWaitTimeMicros</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299600"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-408"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a. Applicative m =&gt; Bool -&gt; m a -&gt; m ()
</span><a href="Lattest.Util.IOUtils.html#ifM_"><span class="hs-identifier hs-var">ifM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679299601"><span class="hs-identifier hs-var">waitTimeMicros</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>                </span><span class="annot"><span class="annottext">Integer -&gt; IO ()
</span><span class="hs-identifier hs-var">delay</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679299601"><span class="hs-identifier hs-var">waitTimeMicros</span></a></span><span>
</span><span id="line-410"></span><span>                </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679299598"><span class="hs-identifier hs-var">waitUntilDelay</span></a></span><span>
</span><span id="line-411"></span><span>        </span><span id="local-6989586621679299606"><span class="annot"><span class="annottext">unblocker :: IO b
</span><a href="#local-6989586621679299606"><span class="hs-identifier hs-var hs-var">unblocker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; STM ()
</span><a href="Lattest.Util.IOUtils.html#waitUntil"><span class="hs-identifier hs-var">waitUntil</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Bool -&gt; STM ()) -&gt; STM Bool -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span><span>
</span><span id="line-413"></span><span>            </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679299598"><span class="hs-identifier hs-var">waitUntilDelay</span></a></span><span>
</span><span id="line-414"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-415"></span><span>            </span><span class="annot"><span class="annottext">IO b
</span><a href="#local-6989586621679299606"><span class="hs-identifier hs-var">unblocker</span></a></span><span>
</span><span id="line-416"></span><span>        </span><span id="local-6989586621679299608"><span class="annot"><span class="annottext">waitUntilUnblocked :: STM ()
</span><a href="#local-6989586621679299608"><span class="hs-identifier hs-var hs-var">waitUntilUnblocked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; STM ()
</span><a href="Lattest.Util.IOUtils.html#waitUntil"><span class="hs-identifier hs-var">waitUntil</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Bool -&gt; STM ()) -&gt; STM Bool -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; STM Bool -&gt; STM Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span id="local-6989586621679299612"><span class="annot"><span class="annottext">waitUntilOutputOrClosed :: STM ()
</span><a href="#local-6989586621679299612"><span class="hs-identifier hs-var hs-var">waitUntilOutputOrClosed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-418"></span><span>            </span><span class="annot"><span class="annottext">STM Bool -&gt; STM () -&gt; STM ()
forall a. STM Bool -&gt; STM a -&gt; STM a
</span><a href="Lattest.Util.IOUtils.html#doAfter"><span class="hs-identifier hs-var">doAfter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM Bool
forall a. TInputStream a -&gt; STM Bool
</span><a href="System.IO.Streams.Synchronized.html#hasInput"><span class="hs-identifier hs-var">hasInput</span></a></span><span> </span><span class="annot"><span class="annottext">(TInputStream (IOAct i o) -&gt; STM Bool)
-&gt; TInputStream (IOAct i o) -&gt; STM Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; TInputStream (IOAct i o)
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- retry if there is no action present (and hence specifically no output)</span><span>
</span><span id="line-419"></span><span>                </span><span id="local-6989586621679299613"><span class="annot"><span class="annottext">Maybe (IOAct i o)
</span><a href="#local-6989586621679299613"><span class="hs-identifier hs-var">mAct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a. TInputStream a -&gt; STM (Maybe a)
</span><a href="System.IO.Streams.Synchronized.html#read"><span class="hs-identifier hs-var">Streams.read</span></a></span><span> </span><span class="annot"><span class="annottext">(TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o)))
-&gt; TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; TInputStream (IOAct i o)
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span> </span><span class="hs-comment">-- 'peek' an action (putting the action back later, because we need to peek more)</span><span>
</span><span id="line-420"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IOAct i o)
</span><a href="#local-6989586621679299613"><span class="hs-identifier hs-var">mAct</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-421"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (IOAct i o)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM ()
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- the stream closed, waiting has finished</span><span>
</span><span id="line-422"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299614"><span class="annot"><span class="annottext">IOAct i o
</span><a href="#local-6989586621679299614"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IOAct i o
</span><a href="#local-6989586621679299614"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-424"></span><span>                            </span><span class="annot"><a href="Lattest.Model.Alphabet.html#Out"><span class="hs-identifier hs-type">Out</span></a></span><span> </span><span class="annot"><span class="annottext">o
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- we've found an output, so waiting has finished</span><span>
</span><span id="line-425"></span><span>                            </span><span class="annot"><a href="Lattest.Model.Alphabet.html#In"><span class="hs-identifier hs-type">In</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM ()
</span><a href="#local-6989586621679299612"><span class="hs-identifier hs-var">waitUntilOutputOrClosed</span></a></span><span> </span><span class="hs-comment">-- recursively peek more, which will either find an output or retry on an absent action</span><span>
</span><span id="line-426"></span><span>                        </span><span class="annot"><span class="annottext">IOAct i o -&gt; TInputStream (IOAct i o) -&gt; STM ()
forall a. a -&gt; TInputStream a -&gt; STM ()
</span><a href="System.IO.Streams.Synchronized.html#unRead"><span class="hs-identifier hs-var">Streams.unRead</span></a></span><span> </span><span class="annot"><span class="annottext">IOAct i o
</span><a href="#local-6989586621679299614"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">(TInputStream (IOAct i o) -&gt; STM ())
-&gt; TInputStream (IOAct i o) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; TInputStream (IOAct i o)
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span> </span><span class="hs-comment">-- now put the 'peeked' action back on the queue</span><span>
</span><span id="line-427"></span><span>        </span><span id="local-6989586621679299616"><span class="annot"><span class="annottext">readFromSut :: STM (Maybe (IOAct i o))
</span><a href="#local-6989586621679299616"><span class="hs-identifier hs-var hs-var">readFromSut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>            </span><span class="annot"><span class="annottext">STM ()
</span><a href="#local-6989586621679299608"><span class="hs-identifier hs-var">waitUntilUnblocked</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; STM () -&gt; STM ()
forall a. STM a -&gt; STM a -&gt; STM a
</span><span class="hs-operator hs-var">`orElse`</span></span><span> </span><span class="annot"><span class="annottext">STM ()
</span><a href="#local-6989586621679299612"><span class="hs-identifier hs-var">waitUntilOutputOrClosed</span></a></span><span>
</span><span id="line-429"></span><span>            </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a. TInputStream a -&gt; STM (Maybe a)
</span><a href="System.IO.Streams.Synchronized.html#read"><span class="hs-identifier hs-var">Streams.read</span></a></span><span> </span><span class="annot"><span class="annottext">(TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o)))
-&gt; TInputStream (IOAct i o) -&gt; STM (Maybe (IOAct i o))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; TInputStream (IOAct i o)
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-430"></span><span>        </span><span id="local-6989586621679299618"><span class="annot"><span class="annottext">hasObservation :: STM Bool
</span><a href="#local-6989586621679299618"><span class="hs-identifier hs-var hs-var">hasObservation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; STM Bool -&gt; STM Bool
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m Bool -&gt; m Bool
</span><span class="hs-operator hs-var">||^</span></span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o) -&gt; STM Bool
forall a. TInputStream a -&gt; STM Bool
</span><a href="System.IO.Streams.Synchronized.html#hasInput"><span class="hs-identifier hs-var">hasInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; TInputStream (IOAct i o)
forall act i. Adapter act i -&gt; TInputStream act
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
forall {b}. IO b
</span><a href="#local-6989586621679299606"><span class="hs-identifier hs-var">unblocker</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span id="local-6989586621679299619"><span class="annot"><span class="annottext">OutputStream i'
</span><a href="#local-6989586621679299619"><span class="hs-identifier hs-var">inputCommandsToSut'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Maybe i' -&gt; IO ()) -&gt; IO (OutputStream i')
forall a. (Maybe a -&gt; IO ()) -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">makeOutputStream</span></span><span> </span><span class="annot"><span class="annottext">((Maybe i' -&gt; IO ()) -&gt; IO (OutputStream i'))
-&gt; (Maybe i' -&gt; IO ()) -&gt; IO (OutputStream i')
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679299620"><span class="annot"><span class="annottext">Maybe i'
</span><a href="#local-6989586621679299620"><span class="hs-identifier hs-var">mInCmd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-433"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe i'
</span><a href="#local-6989586621679299620"><span class="hs-identifier hs-var">mInCmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-434"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679299621"><span class="annot"><span class="annottext">i'
</span><a href="#local-6989586621679299621"><span class="hs-identifier hs-var">inCmd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>                </span><span class="hs-comment">-- waiting is only necessary if the user of the adapter sends a second input without observing an action after the first input</span><span>
</span><span id="line-436"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; STM ()
</span><a href="Lattest.Util.IOUtils.html#waitUntil"><span class="hs-identifier hs-var">waitUntil</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Bool -&gt; STM ()) -&gt; STM Bool -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; STM Bool -&gt; STM Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; STM Bool
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span><span>
</span><span id="line-437"></span><span>                </span><span id="local-6989586621679299622"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299622"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-438"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>                    </span><span class="annot"><span class="annottext">UTCTime -&gt; STM ()
</span><a href="#local-6989586621679299568"><span class="hs-identifier hs-var">updateInputTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679299622"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-440"></span><span>                    </span><span class="annot"><span class="annottext">TVar Bool -&gt; Bool -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621679299564"><span class="hs-identifier hs-var">observationBlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-441"></span><span>                </span><span class="annot"><span class="annottext">Maybe i' -&gt; OutputStream i' -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i' -&gt; Maybe i'
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">i'
</span><a href="#local-6989586621679299621"><span class="hs-identifier hs-var">inCmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OutputStream i' -&gt; IO ()) -&gt; OutputStream i' -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; OutputStream i'
forall act i. Adapter act i -&gt; OutputStream i
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-442"></span><span>            </span><span class="annot"><span class="annottext">Maybe i'
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe i' -&gt; OutputStream i' -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe i'
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(OutputStream i' -&gt; IO ()) -&gt; OutputStream i' -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; OutputStream i'
forall act i. Adapter act i -&gt; OutputStream i
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span> </span><span class="hs-comment">-- Nothing means closing the adapter, forward this to the underlying adapter</span><span>
</span><span id="line-443"></span><span>    </span><span id="local-6989586621679299623"><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299623"><span class="hs-identifier hs-var">actionsFromSut'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (Maybe (IOAct i o))
-&gt; STM Bool -&gt; IO (TInputStream (IOAct i o))
forall a. STM (Maybe a) -&gt; STM Bool -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#makeTInputStream"><span class="hs-identifier hs-var">makeTInputStream</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe (IOAct i o))
</span><a href="#local-6989586621679299616"><span class="hs-identifier hs-var">readFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">STM Bool
</span><a href="#local-6989586621679299618"><span class="hs-identifier hs-var">hasObservation</span></a></span><span>
</span><span id="line-444"></span><span>    </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i')
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i'))
-&gt; Adapter (IOAct i o) i' -&gt; IO (Adapter (IOAct i o) i')
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-445"></span><span>        </span><span class="annot"><span class="annottext">inputCommandsToSut :: OutputStream i'
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputStream i'
</span><a href="#local-6989586621679299619"><span class="hs-identifier hs-var">inputCommandsToSut'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-446"></span><span>        </span><span class="annot"><span class="annottext">actionsFromSut :: TInputStream (IOAct i o)
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TInputStream (IOAct i o)
</span><a href="#local-6989586621679299623"><span class="hs-identifier hs-var">actionsFromSut'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-447"></span><span>        </span><span class="annot"><span class="annottext">close :: IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i' -&gt; IO ()
forall act i. Adapter act i -&gt; IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter (IOAct i o) i'
</span><a href="#local-6989586621679299562"><span class="hs-identifier hs-var">adap</span></a></span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- socket adapter --</span><span>
</span><span id="line-453"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="annot"><span class="hs-comment">-- | Settings for a socket Adapter.</span></span><span>
</span><span id="line-456"></span><span class="hs-keyword">data</span><span> </span><span id="SocketSettings"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier hs-var">SocketSettings</span></a></span></span><span> </span><span id="local-6989586621679299020"><span class="annot"><a href="#local-6989586621679299020"><span class="hs-identifier hs-type">act</span></a></span></span><span> </span><span id="local-6989586621679299021"><span class="annot"><a href="#local-6989586621679299021"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SocketSettings"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier hs-var">SocketSettings</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-457"></span><span>    </span><span id="hostName"><span class="annot"><span class="annottext">forall {k} {k} (act :: k) (i :: k). SocketSettings act i -&gt; String
</span><a href="Lattest.Adapter.StandardAdapters.html#hostName"><span class="hs-identifier hs-var hs-var">hostName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HostName</span></span><span class="hs-special">,</span><span>
</span><span id="line-458"></span><span>    </span><span id="portNumber"><span class="annot"><span class="annottext">forall {k} {k} (act :: k) (i :: k).
SocketSettings act i -&gt; PortNumber
</span><a href="Lattest.Adapter.StandardAdapters.html#portNumber"><span class="hs-identifier hs-var hs-var">portNumber</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span class="annot"><span class="hs-comment">-- | Default settings for a socket Adapter.</span></span><span>
</span><span id="line-462"></span><span id="local-6989586621679299034"><span id="local-6989586621679299035"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#baseSocketSettings"><span class="hs-identifier hs-type">baseSocketSettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier hs-type">SocketSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299034"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299035"><span class="hs-identifier hs-type">i</span></a></span></span></span><span>
</span><span id="line-463"></span><span id="baseSocketSettings"><span class="annot"><span class="annottext">baseSocketSettings :: forall {k} {k} (act :: k) (i :: k). SocketSettings act i
</span><a href="Lattest.Adapter.StandardAdapters.html#baseSocketSettings"><span class="hs-identifier hs-var hs-var">baseSocketSettings</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier hs-type">SocketSettings</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-464"></span><span>    </span><span class="annot"><span class="annottext">hostName :: String
</span><a href="Lattest.Adapter.StandardAdapters.html#hostName"><span class="hs-identifier hs-var">hostName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;127.0.0.1&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-465"></span><span>    </span><span class="annot"><span class="annottext">portNumber :: PortNumber
</span><a href="Lattest.Adapter.StandardAdapters.html#portNumber"><span class="hs-identifier hs-var">portNumber</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><span class="hs-number">2929</span></span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="annot"><span class="hs-comment">-- | Create an adapter by connecting to a server socket, with the default settings.</span></span><span>
</span><span id="line-469"></span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapter"><span class="hs-identifier hs-type">connectSocketAdapter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span id="connectSocketAdapter"><span class="annot"><span class="annottext">connectSocketAdapter :: IO (Adapter ByteString ByteString)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapter"><span class="hs-identifier hs-var hs-var">connectSocketAdapter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SocketSettings Any Any -&gt; IO (Adapter ByteString ByteString)
forall {k} {k} (act :: k) (i :: k).
SocketSettings act i -&gt; IO (Adapter ByteString ByteString)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapterWith"><span class="hs-identifier hs-var">connectSocketAdapterWith</span></a></span><span> </span><span class="annot"><span class="annottext">SocketSettings Any Any
forall {k} {k} (act :: k) (i :: k). SocketSettings act i
</span><a href="Lattest.Adapter.StandardAdapters.html#baseSocketSettings"><span class="hs-identifier hs-var">baseSocketSettings</span></a></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span class="annot"><span class="hs-comment">-- | Create an adapter by connecting to a server socket, with the given settings.</span></span><span>
</span><span id="line-473"></span><span id="local-6989586621679299042"><span id="local-6989586621679299043"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapterWith"><span class="hs-identifier hs-type">connectSocketAdapterWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier hs-type">SocketSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299042"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299043"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-474"></span><span id="connectSocketAdapterWith"><span class="annot"><span class="annottext">connectSocketAdapterWith :: forall {k} {k} (act :: k) (i :: k).
SocketSettings act i -&gt; IO (Adapter ByteString ByteString)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapterWith"><span class="hs-identifier hs-var hs-var">connectSocketAdapterWith</span></a></span></span><span> </span><span id="local-6989586621679299633"><span class="annot"><span class="annottext">SocketSettings act i
</span><a href="#local-6989586621679299633"><span class="hs-identifier hs-var">settings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Adapter ByteString ByteString)
-&gt; IO (Adapter ByteString ByteString)
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">niceSocketsDo</span></span><span> </span><span class="annot"><span class="annottext">(IO (Adapter ByteString ByteString)
 -&gt; IO (Adapter ByteString ByteString))
-&gt; IO (Adapter ByteString ByteString)
-&gt; IO (Adapter ByteString ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-475"></span><span>    </span><span id="local-6989586621679299634"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679299634"><span class="hs-identifier hs-var">socket</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PortNumber -&gt; IO Socket
</span><span class="hs-identifier hs-var">connectTCP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SocketSettings act i -&gt; String
forall {k} {k} (act :: k) (i :: k). SocketSettings act i -&gt; String
</span><a href="Lattest.Adapter.StandardAdapters.html#hostName"><span class="hs-identifier hs-var">hostName</span></a></span><span> </span><span class="annot"><span class="annottext">SocketSettings act i
</span><a href="#local-6989586621679299633"><span class="hs-identifier hs-var">settings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SocketSettings act i -&gt; PortNumber
forall {k} {k} (act :: k) (i :: k).
SocketSettings act i -&gt; PortNumber
</span><a href="Lattest.Adapter.StandardAdapters.html#portNumber"><span class="hs-identifier hs-var">portNumber</span></a></span><span> </span><span class="annot"><span class="annottext">SocketSettings act i
</span><a href="#local-6989586621679299633"><span class="hs-identifier hs-var">settings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679299635"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679299635"><span class="hs-identifier hs-var">actionBytes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679299636"><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679299636"><span class="hs-identifier hs-var">inputCommandBytes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO (InputStream ByteString, OutputStream ByteString)
</span><span class="hs-identifier hs-var">socketToStreams</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679299634"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-477"></span><span>    </span><span id="local-6989586621679299637"><span class="annot"><span class="annottext">TInputStream ByteString
</span><a href="#local-6989586621679299637"><span class="hs-identifier hs-var">forkedActionBytes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InputStream ByteString -&gt; IO (TInputStream ByteString)
forall a. InputStream a -&gt; IO (TInputStream a)
</span><a href="System.IO.Streams.Synchronized.html#fromInputStreamBuffered"><span class="hs-identifier hs-var">fromInputStreamBuffered</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679299635"><span class="hs-identifier hs-var">actionBytes</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="annot"><span class="annottext">Adapter ByteString ByteString -&gt; IO (Adapter ByteString ByteString)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Adapter ByteString ByteString
 -&gt; IO (Adapter ByteString ByteString))
-&gt; Adapter ByteString ByteString
-&gt; IO (Adapter ByteString ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-479"></span><span>        </span><span class="annot"><span class="annottext">inputCommandsToSut :: OutputStream ByteString
</span><a href="Lattest.Adapter.Adapter.html#inputCommandsToSut"><span class="hs-identifier hs-var">inputCommandsToSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679299636"><span class="hs-identifier hs-var">inputCommandBytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="annottext">actionsFromSut :: TInputStream ByteString
</span><a href="Lattest.Adapter.Adapter.html#actionsFromSut"><span class="hs-identifier hs-var">actionsFromSut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TInputStream ByteString
</span><a href="#local-6989586621679299637"><span class="hs-identifier hs-var">forkedActionBytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-481"></span><span>        </span><span class="annot"><span class="annottext">close :: IO ()
</span><a href="Lattest.Adapter.Adapter.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; Int -&gt; IO ()
</span><span class="hs-identifier hs-var">Socket.gracefulClose</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679299634"><span class="hs-identifier hs-var">socket</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span class="annot"><span class="hs-comment">-- | Create an adapter by connecting to a server socket, with the default settings, and sending inputs and reading outputs in JSON format.</span></span><span>
</span><span id="line-485"></span><span id="local-6989586621679299052"><span id="local-6989586621679299053"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapter"><span class="hs-identifier hs-type">connectJSONSocketAdapter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299052"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299053"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299053"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299052"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-486"></span><span id="connectJSONSocketAdapter"><span class="annot"><span class="annottext">connectJSONSocketAdapter :: forall i o. (ToJSON i, FromJSON o) =&gt; IO (Adapter o i)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapter"><span class="hs-identifier hs-var hs-var">connectJSONSocketAdapter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SocketSettings Any i -&gt; IO (Adapter o i)
forall {k} i o (act :: k).
(ToJSON i, FromJSON o) =&gt;
SocketSettings act i -&gt; IO (Adapter o i)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterWith"><span class="hs-identifier hs-var">connectJSONSocketAdapterWith</span></a></span><span> </span><span class="annot"><span class="annottext">SocketSettings Any i
forall {k} {k} (act :: k) (i :: k). SocketSettings act i
</span><a href="Lattest.Adapter.StandardAdapters.html#baseSocketSettings"><span class="hs-identifier hs-var">baseSocketSettings</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span class="annot"><span class="hs-comment">-- | Create an adapter by connecting to a server socket, with the given settings, and sending inputs and reading outputs in JSON format.</span></span><span>
</span><span id="line-489"></span><span id="local-6989586621679299057"><span id="local-6989586621679299058"><span id="local-6989586621679299059"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterWith"><span class="hs-identifier hs-type">connectJSONSocketAdapterWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299057"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299058"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier hs-type">SocketSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299059"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299057"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299058"><span class="hs-identifier hs-type">o</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299057"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-490"></span><span id="connectJSONSocketAdapterWith"><span class="annot"><span class="annottext">connectJSONSocketAdapterWith :: forall {k} i o (act :: k).
(ToJSON i, FromJSON o) =&gt;
SocketSettings act i -&gt; IO (Adapter o i)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterWith"><span class="hs-identifier hs-var hs-var">connectJSONSocketAdapterWith</span></a></span></span><span> </span><span id="local-6989586621679299648"><span class="annot"><span class="annottext">SocketSettings act i
</span><a href="#local-6989586621679299648"><span class="hs-identifier hs-var">settings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-491"></span><span>    </span><span id="local-6989586621679299649"><span class="annot"><span class="annottext">Adapter ByteString ByteString
</span><a href="#local-6989586621679299649"><span class="hs-identifier hs-var">rawAdap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SocketSettings act i -&gt; IO (Adapter ByteString ByteString)
forall {k} {k} (act :: k) (i :: k).
SocketSettings act i -&gt; IO (Adapter ByteString ByteString)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectSocketAdapterWith"><span class="hs-identifier hs-var">connectSocketAdapterWith</span></a></span><span> </span><span class="annot"><span class="annottext">SocketSettings act i
</span><a href="#local-6989586621679299648"><span class="hs-identifier hs-var">settings</span></a></span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621679299650"><span class="annot"><span class="annottext">Adapter o ByteString
</span><a href="#local-6989586621679299650"><span class="hs-identifier hs-var">parsingAdap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Adapter ByteString ByteString -&gt; IO (Adapter o ByteString)
forall act i.
FromJSON act =&gt;
Adapter ByteString i -&gt; IO (Adapter act i)
</span><a href="Lattest.Adapter.StandardAdapters.html#parseJSONActionsFromSut"><span class="hs-identifier hs-var">parseJSONActionsFromSut</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter ByteString ByteString
</span><a href="#local-6989586621679299649"><span class="hs-identifier hs-var">rawAdap</span></a></span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><span class="annottext">Adapter o ByteString -&gt; IO (Adapter o i)
forall i act.
ToJSON i =&gt;
Adapter act ByteString -&gt; IO (Adapter act i)
</span><a href="Lattest.Adapter.StandardAdapters.html#encodeJSONTestChoices"><span class="hs-identifier hs-var">encodeJSONTestChoices</span></a></span><span> </span><span class="annot"><span class="annottext">Adapter o ByteString
</span><a href="#local-6989586621679299650"><span class="hs-identifier hs-var">parsingAdap</span></a></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="annot"><span class="hs-comment">-- | Create an adapter by connecting to a server socket, with the default settings, and sending inputs and reading outputs in JSON format, observing any input as accepted.</span></span><span>
</span><span id="line-496"></span><span id="local-6989586621679299064"><span id="local-6989586621679299065"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterAcceptingInputs"><span class="hs-identifier hs-type">connectJSONSocketAdapterAcceptingInputs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299064"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299065"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299064"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299065"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299064"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-497"></span><span id="connectJSONSocketAdapterAcceptingInputs"><span class="annot"><span class="annottext">connectJSONSocketAdapterAcceptingInputs :: forall i o. (ToJSON i, FromJSON o) =&gt; IO (Adapter (IOAct i o) i)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterAcceptingInputs"><span class="hs-identifier hs-var hs-var">connectJSONSocketAdapterAcceptingInputs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Adapter o i)
forall i o. (ToJSON i, FromJSON o) =&gt; IO (Adapter o i)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapter"><span class="hs-identifier hs-var">connectJSONSocketAdapter</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Adapter o i)
-&gt; (Adapter o i -&gt; IO (Adapter (IOAct i o) i))
-&gt; IO (Adapter (IOAct i o) i)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Adapter o i -&gt; IO (Adapter (IOAct i o) i)
forall o i. Adapter o i -&gt; IO (Adapter (IOAct i o) i)
</span><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputs"><span class="hs-identifier hs-var">acceptingInputs</span></a></span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span class="annot"><span class="hs-comment">-- | Create an adapter by connecting to a server socket, with the given settings, and sending inputs and reading outputs in JSON format, observing any input as accepted.</span></span><span>
</span><span id="line-500"></span><span id="local-6989586621679299069"><span id="local-6989586621679299070"><span id="local-6989586621679299071"><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterAcceptingInputsWith"><span class="hs-identifier hs-type">connectJSONSocketAdapterAcceptingInputsWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299069"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679299070"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Lattest.Adapter.StandardAdapters.html#SocketSettings"><span class="hs-identifier hs-type">SocketSettings</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299071"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299069"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Adapter.Adapter.html#Adapter"><span class="hs-identifier hs-type">Adapter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Lattest.Model.Alphabet.html#IOAct"><span class="hs-identifier hs-type">IOAct</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299069"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679299070"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679299069"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-501"></span><span id="connectJSONSocketAdapterAcceptingInputsWith"><span class="annot"><span class="annottext">connectJSONSocketAdapterAcceptingInputsWith :: forall {k} i o (act :: k).
(ToJSON i, FromJSON o) =&gt;
SocketSettings act i -&gt; IO (Adapter (IOAct i o) i)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterAcceptingInputsWith"><span class="hs-identifier hs-var hs-var">connectJSONSocketAdapterAcceptingInputsWith</span></a></span></span><span> </span><span id="local-6989586621679299661"><span class="annot"><span class="annottext">SocketSettings act i
</span><a href="#local-6989586621679299661"><span class="hs-identifier hs-var">settings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SocketSettings act i -&gt; IO (Adapter o i)
forall {k} i o (act :: k).
(ToJSON i, FromJSON o) =&gt;
SocketSettings act i -&gt; IO (Adapter o i)
</span><a href="Lattest.Adapter.StandardAdapters.html#connectJSONSocketAdapterWith"><span class="hs-identifier hs-var">connectJSONSocketAdapterWith</span></a></span><span> </span><span class="annot"><span class="annottext">SocketSettings act i
</span><a href="#local-6989586621679299661"><span class="hs-identifier hs-var">settings</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Adapter o i)
-&gt; (Adapter o i -&gt; IO (Adapter (IOAct i o) i))
-&gt; IO (Adapter (IOAct i o) i)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Adapter o i -&gt; IO (Adapter (IOAct i o) i)
forall o i. Adapter o i -&gt; IO (Adapter (IOAct i o) i)
</span><a href="Lattest.Adapter.StandardAdapters.html#acceptingInputs"><span class="hs-identifier hs-var">acceptingInputs</span></a></span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span></pre></body></html>